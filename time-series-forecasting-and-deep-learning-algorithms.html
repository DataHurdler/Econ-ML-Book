<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Time Series, Forecasting, and Deep Learning Algorithms | Machine Learning for Economics and Business</title>
  <meta name="description" content="Chapter 3 Time Series, Forecasting, and Deep Learning Algorithms | Machine Learning for Economics and Business" />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Time Series, Forecasting, and Deep Learning Algorithms | Machine Learning for Economics and Business" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="DataHurdler/Econ-ML" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Time Series, Forecasting, and Deep Learning Algorithms | Machine Learning for Economics and Business" />
  
  
  

<meta name="author" content="Zijun Luo" />


<meta name="date" content="2023-07-14" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"/>
<link rel="next" href="regression-reconsidered.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/codefolding-lua-1.1/codefolding-lua.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Machine Learning for Economics and Business</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-should-read-this-book"><i class="fa fa-check"></i>Who Should Read This Book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-use-this-book"><i class="fa fa-check"></i>How to Use This Book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#a-note-on-references"><i class="fa fa-check"></i>A Note on References</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><a href="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><i class="fa fa-check"></i><b>1</b> Randomized Controlled Trial, A/B/N Testing, and Multi-Armed Bandit Algorithms</a>
<ul>
<li class="chapter" data-level="1.1" data-path="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><a href="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><a href="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html#the-explore-exploit-tradeoff"><i class="fa fa-check"></i><b>1.2</b> The Explore-Exploit Tradeoff</a></li>
<li class="chapter" data-level="1.3" data-path="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><a href="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html#epsilon-greedy"><i class="fa fa-check"></i><b>1.3</b> Epsilon Greedy</a></li>
<li class="chapter" data-level="1.4" data-path="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><a href="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html#optimistic-initial-values"><i class="fa fa-check"></i><b>1.4</b> Optimistic Initial Values</a></li>
<li class="chapter" data-level="1.5" data-path="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><a href="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html#upper-confidence-bound-ucb"><i class="fa fa-check"></i><b>1.5</b> Upper Confidence Bound (UCB)</a></li>
<li class="chapter" data-level="1.6" data-path="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><a href="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html#gradient-bandit-algorithm"><i class="fa fa-check"></i><b>1.6</b> Gradient Bandit Algorithm</a></li>
<li class="chapter" data-level="1.7" data-path="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><a href="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html#thompson-sampling-bayesian-bandits"><i class="fa fa-check"></i><b>1.7</b> Thompson Sampling (Bayesian Bandits)</a></li>
<li class="chapter" data-level="1.8" data-path="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><a href="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html#conjugate-prior"><i class="fa fa-check"></i><b>1.8</b> Conjugate Prior</a></li>
<li class="chapter" data-level="1.9" data-path="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><a href="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html#thompson-sampling-code"><i class="fa fa-check"></i><b>1.9</b> Thompson Sampling: Code</a></li>
<li class="chapter" data-level="1.10" data-path="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><a href="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html#comparing-the-algorithms"><i class="fa fa-check"></i><b>1.10</b> Comparing the Algorithms</a></li>
<li class="chapter" data-level="1.11" data-path="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><a href="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html#summary-and-extensions"><i class="fa fa-check"></i><b>1.11</b> Summary and Extensions</a></li>
<li class="chapter" data-level="1.12" data-path="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html"><a href="randomized-controlled-trial-abn-testing-and-multi-armed-bandit-algorithms.html#references"><i class="fa fa-check"></i><b>1.12</b> References</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><i class="fa fa-check"></i><b>2</b> Discrete Choice, Classification, and Tree-Based Ensemble Algorithms</a>
<ul>
<li class="chapter" data-level="2.1" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html#introduction-1"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html#the-bias-variance-tradeoff"><i class="fa fa-check"></i><b>2.2</b> The Bias-Variance Tradeoff</a></li>
<li class="chapter" data-level="2.3" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html#decision-tree"><i class="fa fa-check"></i><b>2.3</b> Decision Tree</a></li>
<li class="chapter" data-level="2.4" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html#split-criterion"><i class="fa fa-check"></i><b>2.4</b> Split Criterion</a></li>
<li class="chapter" data-level="2.5" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html#pruning"><i class="fa fa-check"></i><b>2.5</b> Pruning</a></li>
<li class="chapter" data-level="2.6" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html#bagging-and-random-forest"><i class="fa fa-check"></i><b>2.6</b> Bagging and Random Forest</a></li>
<li class="chapter" data-level="2.7" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html#boosting-and-adaboost"><i class="fa fa-check"></i><b>2.7</b> Boosting and AdaBoost</a></li>
<li class="chapter" data-level="2.8" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html#gradient-boosting-and-xgboost"><i class="fa fa-check"></i><b>2.8</b> Gradient Boosting and XGBoost</a></li>
<li class="chapter" data-level="2.9" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html#python-implementation-with-scikit-learn"><i class="fa fa-check"></i><b>2.9</b> Python Implementation with scikit-learn</a></li>
<li class="chapter" data-level="2.10" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html#confusion-matrix-and-other-performance-metrics"><i class="fa fa-check"></i><b>2.10</b> Confusion Matrix and other Performance Metrics</a></li>
<li class="chapter" data-level="2.11" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html#comparison-the-algorithms"><i class="fa fa-check"></i><b>2.11</b> Comparison the Algorithms</a></li>
<li class="chapter" data-level="2.12" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html#summary"><i class="fa fa-check"></i><b>2.12</b> Summary</a></li>
<li class="chapter" data-level="2.13" data-path="discrete-choice-classification-and-tree-based-ensemble-algorithms.html"><a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html#references-1"><i class="fa fa-check"></i><b>2.13</b> References</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="time-series-forecasting-and-deep-learning-algorithms.html"><a href="time-series-forecasting-and-deep-learning-algorithms.html"><i class="fa fa-check"></i><b>3</b> Time Series, Forecasting, and Deep Learning Algorithms</a>
<ul>
<li class="chapter" data-level="3.1" data-path="time-series-forecasting-and-deep-learning-algorithms.html"><a href="time-series-forecasting-and-deep-learning-algorithms.html#introduction-2"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="time-series-forecasting-and-deep-learning-algorithms.html"><a href="time-series-forecasting-and-deep-learning-algorithms.html#time-series-implementation-in-statsmodels"><i class="fa fa-check"></i><b>3.2</b> Time Series Implementation in <code>statsmodels</code></a></li>
<li class="chapter" data-level="3.3" data-path="time-series-forecasting-and-deep-learning-algorithms.html"><a href="time-series-forecasting-and-deep-learning-algorithms.html#artificial-neural-network-ann"><i class="fa fa-check"></i><b>3.3</b> Artificial Neural Network (ANN)</a></li>
<li class="chapter" data-level="3.4" data-path="time-series-forecasting-and-deep-learning-algorithms.html"><a href="time-series-forecasting-and-deep-learning-algorithms.html#recurrent-neural-network-rnn"><i class="fa fa-check"></i><b>3.4</b> Recurrent Neural Network (RNN)</a></li>
<li class="chapter" data-level="3.5" data-path="time-series-forecasting-and-deep-learning-algorithms.html"><a href="time-series-forecasting-and-deep-learning-algorithms.html#convolutional-neural-network-cnn"><i class="fa fa-check"></i><b>3.5</b> Convolutional Neural Network (CNN)</a></li>
<li class="chapter" data-level="3.6" data-path="time-series-forecasting-and-deep-learning-algorithms.html"><a href="time-series-forecasting-and-deep-learning-algorithms.html#deep-learning-algorithms-in-tensorflowkeras"><i class="fa fa-check"></i><b>3.6</b> Deep Learning Algorithms in TensorFlow/Keras</a></li>
<li class="chapter" data-level="3.7" data-path="time-series-forecasting-and-deep-learning-algorithms.html"><a href="time-series-forecasting-and-deep-learning-algorithms.html#facebooks-prophet"><i class="fa fa-check"></i><b>3.7</b> Facebook’s Prophet</a></li>
<li class="chapter" data-level="3.8" data-path="time-series-forecasting-and-deep-learning-algorithms.html"><a href="time-series-forecasting-and-deep-learning-algorithms.html#summary-1"><i class="fa fa-check"></i><b>3.8</b> Summary</a></li>
<li class="chapter" data-level="3.9" data-path="time-series-forecasting-and-deep-learning-algorithms.html"><a href="time-series-forecasting-and-deep-learning-algorithms.html#references-incomplete"><i class="fa fa-check"></i><b>3.9</b> References (incomplete)</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="regression-reconsidered.html"><a href="regression-reconsidered.html"><i class="fa fa-check"></i><b>4</b> Regression Reconsidered</a></li>
<li class="chapter" data-level="5" data-path="causal-inference-reconsidered.html"><a href="causal-inference-reconsidered.html"><i class="fa fa-check"></i><b>5</b> Causal Inference Reconsidered</a></li>
<li class="chapter" data-level="6" data-path="more-than-meets-the-eye.html"><a href="more-than-meets-the-eye.html"><i class="fa fa-check"></i><b>6</b> More than Meets the Eye</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Machine Learning for Economics and Business</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="time-series-forecasting-and-deep-learning-algorithms" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Time Series, Forecasting, and Deep Learning Algorithms<a href="time-series-forecasting-and-deep-learning-algorithms.html#time-series-forecasting-and-deep-learning-algorithms" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introduction-2" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Introduction<a href="time-series-forecasting-and-deep-learning-algorithms.html#introduction-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This chapter is structured differently from other chapters. We will begin with Python implementations for time-series/forecasting models that are not machine learning based. This is accomplished primarily with the Python library <code>statsmodels</code>. The section serves as both a review of forecasting concepts and an introduction to the <code>statsmodels</code> library, another widely used Python library for statistical/data analysis.</p>
<p>The main emphasis of this chapter, however, is the use of <code>deep learning</code> models for forecasting tasks. We will introduce three neural network models: <code>Artificial Neural Networks</code> (ANN), <code>Reccurent Neural Networks</code> (RNN), and <code>Convolutional Neural Networks</code> (CNN). We will implement these models in Python using <code>Keras</code> from TensorFlow<code>. The chapter ends with the introduction to</code>Facebook<code>'s</code>Prophet` library, which is a widely-used library for forecasting in the industry.</p>
<p><strong>Forecasting</strong> should need no introduction. At its simplest form, you have a time series data set with values of a single object/individual overtime, and you attempt to predict the “next” value into the future. In more complicated cases, you may have covariates/features, as long as these features are observable at the moment of forecasting and do not result in <strong>information leakage</strong>. For example, if you are doing weather forecast and your goal is to forecast whether it is going to rain tomorrow, your data set should contain only information of whether it has rained or not in the past many days in which additional features such as temperature, dew point, and precipitation may be included. These additional weather variables should be from the day before your forecast, not the day of your forecast, when you are training your model. A classic example of information leakage happens when forecasting with moving average (MA) values. For example, if you are doing a 3-day MA, then the value of today requires the use of the value from tomorrow, which is only possible in historic data but not with real data.</p>
</div>
<div id="time-series-implementation-in-statsmodels" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Time Series Implementation in <code>statsmodels</code><a href="time-series-forecasting-and-deep-learning-algorithms.html#time-series-implementation-in-statsmodels" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this section, we will implement three forecasting models: <code>Exponential Smoothing (ETS)</code>, <code>Vector Autoregression (VAR)</code>, and <code>Autoregressive Integrated Moving Average (ARIMA)</code>. ETS and ARIMA are run with a single time series, whereas VAR uses several. The data set we will use is U.S. stock exchange (close) prices from the Python library <code>yfinance</code>. For ETS, we will also implement a walk-forward validation, which is the correct form of validation for time series data, analogue to cross validation seen in the last chapter. To show the power of Auto Machine Learning, we will implement auto ARIMA from the Python library <code>pmdarima</code>. Here is the full Python script:</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-1" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb43-2"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb43-3"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb43-4"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-4" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb43-5"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-5" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb43-6"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-6" tabindex="-1"></a></span>
<span id="cb43-7"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-7" tabindex="-1"></a><span class="im">from</span> statsmodels.graphics.tsaplots <span class="im">import</span> plot_acf, plot_pacf</span>
<span id="cb43-8"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-8" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.holtwinters <span class="im">import</span> ExponentialSmoothing</span>
<span id="cb43-9"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-9" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.api <span class="im">import</span> VAR</span>
<span id="cb43-10"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-10" tabindex="-1"></a><span class="im">import</span> pmdarima <span class="im">as</span> pm</span>
<span id="cb43-11"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-11" tabindex="-1"></a></span>
<span id="cb43-12"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-12" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score</span>
<span id="cb43-13"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-13" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb43-14"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-14" tabindex="-1"></a></span>
<span id="cb43-15"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-15" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb43-16"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-16" tabindex="-1"></a></span>
<span id="cb43-17"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-17" tabindex="-1"></a>warnings.filterwarnings(<span class="st">&quot;ignore&quot;</span>)  <span class="co"># ignore warnings</span></span>
<span id="cb43-18"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-18" tabindex="-1"></a></span>
<span id="cb43-19"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-19" tabindex="-1"></a></span>
<span id="cb43-20"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-20" tabindex="-1"></a><span class="kw">def</span> prepare_data(df):</span>
<span id="cb43-21"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-21" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb43-22"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-22" tabindex="-1"></a><span class="co">    Split the data into training and testing sets.</span></span>
<span id="cb43-23"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-23" tabindex="-1"></a></span>
<span id="cb43-24"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-24" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb43-25"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-25" tabindex="-1"></a><span class="co">        df (pandas.DataFrame): The input dataframe.</span></span>
<span id="cb43-26"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-26" tabindex="-1"></a></span>
<span id="cb43-27"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-27" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb43-28"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-28" tabindex="-1"></a><span class="co">        tuple: A tuple containing the train set, test set, train index, and test index.</span></span>
<span id="cb43-29"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-29" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb43-30"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-30" tabindex="-1"></a>    train <span class="op">=</span> df.iloc[:<span class="op">-</span>N_TEST]</span>
<span id="cb43-31"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-31" tabindex="-1"></a>    test <span class="op">=</span> df.iloc[<span class="op">-</span>N_TEST:]</span>
<span id="cb43-32"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-32" tabindex="-1"></a>    train_idx <span class="op">=</span> df.index <span class="op">&lt;=</span> train.index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb43-33"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-33" tabindex="-1"></a>    test_idx <span class="op">=</span> df.index <span class="op">&gt;</span> train.index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb43-34"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-34" tabindex="-1"></a></span>
<span id="cb43-35"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-35" tabindex="-1"></a>    <span class="cf">return</span> train, test, train_idx, test_idx</span>
<span id="cb43-36"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-36" tabindex="-1"></a></span>
<span id="cb43-37"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-37" tabindex="-1"></a></span>
<span id="cb43-38"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-38" tabindex="-1"></a><span class="kw">def</span> plot_fitted_forecast(df, name, col<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb43-39"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-39" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb43-40"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-40" tabindex="-1"></a><span class="co">    Plot the fitted and forecasted values of a time series.</span></span>
<span id="cb43-41"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-41" tabindex="-1"></a></span>
<span id="cb43-42"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-42" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb43-43"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-43" tabindex="-1"></a><span class="co">        df (pandas.DataFrame): The input dataframe.</span></span>
<span id="cb43-44"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-44" tabindex="-1"></a><span class="co">        name (str): Name of model that is being plotted.</span></span>
<span id="cb43-45"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-45" tabindex="-1"></a><span class="co">        col (str): The column name to plot. Default is None.</span></span>
<span id="cb43-46"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-46" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb43-47"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-47" tabindex="-1"></a>    df <span class="op">=</span> df[<span class="op">-</span><span class="dv">54</span>:]  <span class="co"># only plot the last 54 days</span></span>
<span id="cb43-48"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-48" tabindex="-1"></a></span>
<span id="cb43-49"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-49" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb43-50"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-50" tabindex="-1"></a>    ax.plot(df.index, df[<span class="ss">f&quot;</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">&quot;</span>], label<span class="op">=</span><span class="st">&#39;data&#39;</span>)</span>
<span id="cb43-51"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-51" tabindex="-1"></a>    ax.plot(df.index, df[<span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_fitted&quot;</span>], label<span class="op">=</span><span class="st">&#39;fitted&#39;</span>)</span>
<span id="cb43-52"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-52" tabindex="-1"></a>    ax.plot(df.index, df[<span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_forecast&quot;</span>], label<span class="op">=</span><span class="st">&#39;forecast&#39;</span>)</span>
<span id="cb43-53"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-53" tabindex="-1"></a></span>
<span id="cb43-54"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-54" tabindex="-1"></a>    plt.legend()</span>
<span id="cb43-55"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-55" tabindex="-1"></a>    plt.savefig(<span class="ss">f&quot;statsmodels_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb43-56"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-56" tabindex="-1"></a></span>
<span id="cb43-57"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-57" tabindex="-1"></a></span>
<span id="cb43-58"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-58" tabindex="-1"></a><span class="kw">class</span> StocksForecast:</span>
<span id="cb43-59"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-59" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, stock_name_list<span class="op">=</span>(<span class="st">&#39;UAL&#39;</span>, <span class="st">&#39;WMT&#39;</span>, <span class="st">&#39;PFE&#39;</span>), start_date<span class="op">=</span><span class="st">&#39;2018-01-01&#39;</span>, end_date<span class="op">=</span><span class="st">&#39;2022-12-31&#39;</span>):</span>
<span id="cb43-60"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-60" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb43-61"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-61" tabindex="-1"></a><span class="co">        Initialize the StocksForecast class.</span></span>
<span id="cb43-62"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-62" tabindex="-1"></a></span>
<span id="cb43-63"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-63" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb43-64"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-64" tabindex="-1"></a><span class="co">            stock_name_list (list[str]): List of stock names. Default is (&#39;UAL&#39;, &#39;WMT&#39;, &#39;PFE&#39;).</span></span>
<span id="cb43-65"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-65" tabindex="-1"></a><span class="co">            start_date (str): Start date of the data. Default is &#39;2018-01-01&#39;.</span></span>
<span id="cb43-66"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-66" tabindex="-1"></a><span class="co">            end_date (str): End date of the data. Default is &#39;2022-12-31&#39;.</span></span>
<span id="cb43-67"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-67" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb43-68"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-68" tabindex="-1"></a>        <span class="va">self</span>.dfs <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb43-69"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-69" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> stock_name_list:</span>
<span id="cb43-70"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-70" tabindex="-1"></a>            <span class="va">self</span>.dfs[name] <span class="op">=</span> yf.download(name, start<span class="op">=</span>start_date, end<span class="op">=</span>end_date)</span>
<span id="cb43-71"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-71" tabindex="-1"></a>            <span class="va">self</span>.dfs[name][<span class="st">&#39;Diff&#39;</span>] <span class="op">=</span> <span class="va">self</span>.dfs[name][<span class="st">&#39;Close&#39;</span>].diff(<span class="dv">1</span>)</span>
<span id="cb43-72"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-72" tabindex="-1"></a>            <span class="va">self</span>.dfs[name][<span class="st">&#39;Log&#39;</span>] <span class="op">=</span> np.log(<span class="va">self</span>.dfs[name][<span class="st">&#39;Close&#39;</span>])</span>
<span id="cb43-73"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-73" tabindex="-1"></a></span>
<span id="cb43-74"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-74" tabindex="-1"></a>        <span class="va">self</span>.result_for_plot <span class="op">=</span> pd.DataFrame(index<span class="op">=</span><span class="va">self</span>.dfs[stock_name_list[<span class="dv">0</span>]].index)</span>
<span id="cb43-75"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-75" tabindex="-1"></a></span>
<span id="cb43-76"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-76" tabindex="-1"></a>    <span class="kw">def</span> run_ets(<span class="va">self</span>, stock_name<span class="op">=</span><span class="st">&#39;UAL&#39;</span>, col<span class="op">=</span><span class="st">&#39;Close&#39;</span>):</span>
<span id="cb43-77"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-77" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb43-78"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-78" tabindex="-1"></a><span class="co">        Run the Exponential Smoothing (ETS) model on the specified stock.</span></span>
<span id="cb43-79"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-79" tabindex="-1"></a></span>
<span id="cb43-80"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-80" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb43-81"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-81" tabindex="-1"></a><span class="co">            stock_name (str): The name of the stock. Default is &#39;UAL&#39;.</span></span>
<span id="cb43-82"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-82" tabindex="-1"></a><span class="co">            col (str): The column name to use for the model. Default is &#39;Close&#39;.</span></span>
<span id="cb43-83"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-83" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb43-84"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-84" tabindex="-1"></a>        name <span class="op">=</span> <span class="st">&#39;ets&#39;</span></span>
<span id="cb43-85"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-85" tabindex="-1"></a></span>
<span id="cb43-86"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-86" tabindex="-1"></a>        df_all <span class="op">=</span> <span class="va">self</span>.dfs[stock_name]</span>
<span id="cb43-87"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-87" tabindex="-1"></a>        train, test, train_idx, test_idx <span class="op">=</span> prepare_data(df_all)</span>
<span id="cb43-88"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-88" tabindex="-1"></a></span>
<span id="cb43-89"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-89" tabindex="-1"></a>        model <span class="op">=</span> ExponentialSmoothing(train[col].dropna(), trend<span class="op">=</span><span class="st">&#39;mul&#39;</span>, seasonal<span class="op">=</span><span class="st">&#39;mul&#39;</span>, seasonal_periods<span class="op">=</span><span class="dv">252</span>)</span>
<span id="cb43-90"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-90" tabindex="-1"></a>        result <span class="op">=</span> model.fit()</span>
<span id="cb43-91"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-91" tabindex="-1"></a></span>
<span id="cb43-92"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-92" tabindex="-1"></a>        df_all.loc[train_idx, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_fitted&quot;</span>] <span class="op">=</span> result.fittedvalues</span>
<span id="cb43-93"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-93" tabindex="-1"></a>        df_all.loc[test_idx, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_forecast&quot;</span>] <span class="op">=</span> np.array(result.forecast(N_TEST))</span>
<span id="cb43-94"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-94" tabindex="-1"></a></span>
<span id="cb43-95"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-95" tabindex="-1"></a>        <span class="va">self</span>.result_for_plot <span class="op">=</span> <span class="va">self</span>.result_for_plot.merge(df_all[[<span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_fitted&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_forecast&quot;</span>]],</span>
<span id="cb43-96"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-96" tabindex="-1"></a>                                                          left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb43-97"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-97" tabindex="-1"></a>                                                          right_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-98"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-98" tabindex="-1"></a></span>
<span id="cb43-99"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-99" tabindex="-1"></a>        plot_fitted_forecast(df_all, <span class="st">&#39;ets&#39;</span>, col)</span>
<span id="cb43-100"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-100" tabindex="-1"></a></span>
<span id="cb43-101"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-101" tabindex="-1"></a>    <span class="kw">def</span> walkforward_ets(<span class="va">self</span>, h, steps, tuple_of_option_lists, stock_name<span class="op">=</span><span class="st">&#39;UAL&#39;</span>, col<span class="op">=</span><span class="st">&#39;Close&#39;</span>, debug<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb43-102"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-102" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb43-103"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-103" tabindex="-1"></a><span class="co">        Perform walk-forward validation on the specified stock. Only supports ExponentialSmoothing</span></span>
<span id="cb43-104"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-104" tabindex="-1"></a></span>
<span id="cb43-105"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-105" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb43-106"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-106" tabindex="-1"></a><span class="co">            h (int): The forecast horizon.</span></span>
<span id="cb43-107"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-107" tabindex="-1"></a><span class="co">            steps (int): The number of steps to walk forward.</span></span>
<span id="cb43-108"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-108" tabindex="-1"></a><span class="co">            tuple_of_option_lists (tuple): Tuple of option lists for trend and seasonal types.</span></span>
<span id="cb43-109"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-109" tabindex="-1"></a><span class="co">            stock_name (str): The name of the stock. Default is &#39;UAL&#39;.</span></span>
<span id="cb43-110"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-110" tabindex="-1"></a><span class="co">            col (str): The column name to use for the model. Default is &#39;Close&#39;.</span></span>
<span id="cb43-111"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-111" tabindex="-1"></a><span class="co">            debug (bool): Whether to print debug information. Default is False.</span></span>
<span id="cb43-112"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-112" tabindex="-1"></a></span>
<span id="cb43-113"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-113" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb43-114"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-114" tabindex="-1"></a><span class="co">            float: The mean of squared errors.</span></span>
<span id="cb43-115"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-115" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb43-116"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-116" tabindex="-1"></a>        errors <span class="op">=</span> []</span>
<span id="cb43-117"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-117" tabindex="-1"></a>        seen_last <span class="op">=</span> <span class="va">False</span></span>
<span id="cb43-118"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-118" tabindex="-1"></a>        steps_completed <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-119"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-119" tabindex="-1"></a>        df <span class="op">=</span> <span class="va">self</span>.dfs[stock_name]</span>
<span id="cb43-120"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-120" tabindex="-1"></a>        Ntest <span class="op">=</span> <span class="bu">len</span>(df) <span class="op">-</span> h <span class="op">-</span> steps <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb43-121"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-121" tabindex="-1"></a></span>
<span id="cb43-122"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-122" tabindex="-1"></a>        trend_type, seasonal_type <span class="op">=</span> tuple_of_option_lists</span>
<span id="cb43-123"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-123" tabindex="-1"></a></span>
<span id="cb43-124"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-124" tabindex="-1"></a>        <span class="cf">for</span> end_of_train <span class="kw">in</span> <span class="bu">range</span>(Ntest, <span class="bu">len</span>(df) <span class="op">-</span> h <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb43-125"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-125" tabindex="-1"></a>            train <span class="op">=</span> df.iloc[:end_of_train]</span>
<span id="cb43-126"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-126" tabindex="-1"></a>            test <span class="op">=</span> df.iloc[end_of_train:end_of_train <span class="op">+</span> h]</span>
<span id="cb43-127"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-127" tabindex="-1"></a></span>
<span id="cb43-128"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-128" tabindex="-1"></a>            <span class="cf">if</span> test.index[<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> df.index[<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb43-129"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-129" tabindex="-1"></a>                seen_last <span class="op">=</span> <span class="va">True</span></span>
<span id="cb43-130"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-130" tabindex="-1"></a></span>
<span id="cb43-131"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-131" tabindex="-1"></a>            steps_completed <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb43-132"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-132" tabindex="-1"></a></span>
<span id="cb43-133"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-133" tabindex="-1"></a>            hw <span class="op">=</span> ExponentialSmoothing(train[col], trend<span class="op">=</span>trend_type, seasonal<span class="op">=</span>seasonal_type, seasonal_periods<span class="op">=</span><span class="dv">40</span>)</span>
<span id="cb43-134"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-134" tabindex="-1"></a></span>
<span id="cb43-135"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-135" tabindex="-1"></a>            result_hw <span class="op">=</span> hw.fit()</span>
<span id="cb43-136"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-136" tabindex="-1"></a></span>
<span id="cb43-137"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-137" tabindex="-1"></a>            forecast <span class="op">=</span> result_hw.forecast(h)</span>
<span id="cb43-138"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-138" tabindex="-1"></a>            error <span class="op">=</span> mean_squared_error(test[col], np.array(forecast))</span>
<span id="cb43-139"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-139" tabindex="-1"></a>            errors.append(error)</span>
<span id="cb43-140"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-140" tabindex="-1"></a></span>
<span id="cb43-141"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-141" tabindex="-1"></a>        <span class="cf">if</span> debug:</span>
<span id="cb43-142"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-142" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;seen_last:&quot;</span>, seen_last)</span>
<span id="cb43-143"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-143" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;steps completed:&quot;</span>, steps_completed)</span>
<span id="cb43-144"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-144" tabindex="-1"></a></span>
<span id="cb43-145"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-145" tabindex="-1"></a>        <span class="cf">return</span> np.mean(errors)</span>
<span id="cb43-146"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-146" tabindex="-1"></a></span>
<span id="cb43-147"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-147" tabindex="-1"></a>    <span class="kw">def</span> run_walkforward(<span class="va">self</span>, h, steps, stock_name, col, options):</span>
<span id="cb43-148"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-148" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb43-149"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-149" tabindex="-1"></a><span class="co">            Perform walk-forward validation on the specified stock using Exponential Smoothing (ETS).</span></span>
<span id="cb43-150"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-150" tabindex="-1"></a></span>
<span id="cb43-151"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-151" tabindex="-1"></a><span class="co">            Args:</span></span>
<span id="cb43-152"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-152" tabindex="-1"></a><span class="co">                h (int): The forecast horizon.</span></span>
<span id="cb43-153"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-153" tabindex="-1"></a><span class="co">                steps (int): The number of steps to walk forward.</span></span>
<span id="cb43-154"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-154" tabindex="-1"></a><span class="co">                stock_name (str): The name of the stock.</span></span>
<span id="cb43-155"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-155" tabindex="-1"></a><span class="co">                col (str): The column name to use for the model.</span></span>
<span id="cb43-156"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-156" tabindex="-1"></a><span class="co">                options (tuple): Tuple of option lists for trend and seasonal types.</span></span>
<span id="cb43-157"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-157" tabindex="-1"></a></span>
<span id="cb43-158"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-158" tabindex="-1"></a><span class="co">            Returns:</span></span>
<span id="cb43-159"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-159" tabindex="-1"></a><span class="co">                float: The mean squared error (MSE) of the forecast.</span></span>
<span id="cb43-160"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-160" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb43-161"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-161" tabindex="-1"></a>        best_score <span class="op">=</span> <span class="bu">float</span>(<span class="st">&#39;inf&#39;</span>)</span>
<span id="cb43-162"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-162" tabindex="-1"></a>        best_options <span class="op">=</span> <span class="va">None</span></span>
<span id="cb43-163"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-163" tabindex="-1"></a></span>
<span id="cb43-164"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-164" tabindex="-1"></a>        <span class="cf">for</span> x <span class="kw">in</span> itertools.product(<span class="op">*</span>options):</span>
<span id="cb43-165"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-165" tabindex="-1"></a>            score <span class="op">=</span> <span class="va">self</span>.walkforward_ets(h<span class="op">=</span>h, steps<span class="op">=</span>steps, stock_name<span class="op">=</span>stock_name, col<span class="op">=</span>col, tuple_of_option_lists<span class="op">=</span>x)</span>
<span id="cb43-166"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-166" tabindex="-1"></a></span>
<span id="cb43-167"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-167" tabindex="-1"></a>            <span class="cf">if</span> score <span class="op">&lt;</span> best_score:</span>
<span id="cb43-168"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-168" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;Best score so far:&quot;</span>, score)</span>
<span id="cb43-169"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-169" tabindex="-1"></a>                best_score <span class="op">=</span> score</span>
<span id="cb43-170"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-170" tabindex="-1"></a>                best_options <span class="op">=</span> x</span>
<span id="cb43-171"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-171" tabindex="-1"></a></span>
<span id="cb43-172"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-172" tabindex="-1"></a>        trend_type, seasonal_type <span class="op">=</span> best_options</span>
<span id="cb43-173"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-173" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;best trend type: </span><span class="sc">{</span>trend_type<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb43-174"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-174" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;best seasonal type: </span><span class="sc">{</span>seasonal_type<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb43-175"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-175" tabindex="-1"></a></span>
<span id="cb43-176"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-176" tabindex="-1"></a>    <span class="kw">def</span> prepare_data_var(<span class="va">self</span>, stock_list, col):</span>
<span id="cb43-177"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-177" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb43-178"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-178" tabindex="-1"></a><span class="co">            Prepare the data for Vector Autoregression (VAR) modeling.</span></span>
<span id="cb43-179"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-179" tabindex="-1"></a></span>
<span id="cb43-180"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-180" tabindex="-1"></a><span class="co">            Args:</span></span>
<span id="cb43-181"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-181" tabindex="-1"></a><span class="co">                stock_list (list): List of stock names.</span></span>
<span id="cb43-182"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-182" tabindex="-1"></a><span class="co">                col (str): The column name to use for the model.</span></span>
<span id="cb43-183"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-183" tabindex="-1"></a></span>
<span id="cb43-184"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-184" tabindex="-1"></a><span class="co">            Returns:</span></span>
<span id="cb43-185"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-185" tabindex="-1"></a><span class="co">                tuple: A tuple containing the combined dataframe, train set, test set, train index,</span></span>
<span id="cb43-186"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-186" tabindex="-1"></a><span class="co">                       test index, stock columns, and scaled columns.</span></span>
<span id="cb43-187"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-187" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb43-188"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-188" tabindex="-1"></a>        df_all <span class="op">=</span> pd.DataFrame(index<span class="op">=</span><span class="va">self</span>.dfs[stock_list[<span class="dv">0</span>]].index)</span>
<span id="cb43-189"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-189" tabindex="-1"></a>        <span class="cf">for</span> stock <span class="kw">in</span> stock_list:</span>
<span id="cb43-190"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-190" tabindex="-1"></a>            df_all <span class="op">=</span> df_all.join(<span class="va">self</span>.dfs[stock][col].dropna())</span>
<span id="cb43-191"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-191" tabindex="-1"></a>            df_all.rename(columns<span class="op">=</span>{col: <span class="ss">f&quot;</span><span class="sc">{</span>stock<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">&quot;</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-192"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-192" tabindex="-1"></a></span>
<span id="cb43-193"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-193" tabindex="-1"></a>        train, test, train_idx, test_idx <span class="op">=</span> prepare_data(df_all)</span>
<span id="cb43-194"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-194" tabindex="-1"></a></span>
<span id="cb43-195"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-195" tabindex="-1"></a>        stock_cols <span class="op">=</span> df_all.columns.values</span>
<span id="cb43-196"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-196" tabindex="-1"></a></span>
<span id="cb43-197"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-197" tabindex="-1"></a>        <span class="co"># save all scalers into a list for inverse_transform fitted values and forecast</span></span>
<span id="cb43-198"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-198" tabindex="-1"></a>        scaler_list <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb43-199"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-199" tabindex="-1"></a>        scaler_idx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-200"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-200" tabindex="-1"></a></span>
<span id="cb43-201"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-201" tabindex="-1"></a>        <span class="co"># standardizing different stocks</span></span>
<span id="cb43-202"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-202" tabindex="-1"></a>        <span class="cf">for</span> value <span class="kw">in</span> stock_cols:</span>
<span id="cb43-203"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-203" tabindex="-1"></a>            scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb43-204"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-204" tabindex="-1"></a>            scaler_list.append(scaler)</span>
<span id="cb43-205"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-205" tabindex="-1"></a>            scaler_idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb43-206"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-206" tabindex="-1"></a></span>
<span id="cb43-207"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-207" tabindex="-1"></a>            train[<span class="ss">f&#39;Scaled_</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">&#39;</span>] <span class="op">=</span> scaler.fit_transform(train[[value]])</span>
<span id="cb43-208"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-208" tabindex="-1"></a>            test[<span class="ss">f&#39;Scaled_</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">&#39;</span>] <span class="op">=</span> scaler.transform(test[[value]])</span>
<span id="cb43-209"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-209" tabindex="-1"></a>            df_all.loc[train_idx, <span class="ss">f&#39;Scaled_</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">&#39;</span>] <span class="op">=</span> train[<span class="ss">f&#39;Scaled_</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">&#39;</span>]</span>
<span id="cb43-210"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-210" tabindex="-1"></a>            df_all.loc[test_idx, <span class="ss">f&#39;Scaled_</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">&#39;</span>] <span class="op">=</span> test[<span class="ss">f&#39;Scaled_</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">&#39;</span>]</span>
<span id="cb43-211"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-211" tabindex="-1"></a></span>
<span id="cb43-212"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-212" tabindex="-1"></a>        cols <span class="op">=</span> [<span class="st">&#39;Scaled_&#39;</span> <span class="op">+</span> value <span class="cf">for</span> value <span class="kw">in</span> stock_cols]</span>
<span id="cb43-213"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-213" tabindex="-1"></a></span>
<span id="cb43-214"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-214" tabindex="-1"></a>        <span class="cf">return</span> df_all, train, test, train_idx, test_idx, stock_cols, cols, scaler_list</span>
<span id="cb43-215"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-215" tabindex="-1"></a></span>
<span id="cb43-216"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-216" tabindex="-1"></a>    <span class="kw">def</span> run_var(<span class="va">self</span>, stock_list<span class="op">=</span>(<span class="st">&#39;UAL&#39;</span>, <span class="st">&#39;WMT&#39;</span>, <span class="st">&#39;PFE&#39;</span>), col<span class="op">=</span><span class="st">&#39;Close&#39;</span>):</span>
<span id="cb43-217"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-217" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb43-218"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-218" tabindex="-1"></a><span class="co">        Run the Vector Autoregression (VAR) model on the specified stocks.</span></span>
<span id="cb43-219"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-219" tabindex="-1"></a></span>
<span id="cb43-220"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-220" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb43-221"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-221" tabindex="-1"></a><span class="co">            stock_list (tuple): Tuple of stock names. Default is (&#39;UAL&#39;, &#39;WMT&#39;, &#39;PFE&#39;).</span></span>
<span id="cb43-222"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-222" tabindex="-1"></a><span class="co">            col (str): The column name to use for the model. Default is &#39;Close&#39;.</span></span>
<span id="cb43-223"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-223" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb43-224"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-224" tabindex="-1"></a></span>
<span id="cb43-225"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-225" tabindex="-1"></a>        name <span class="op">=</span> <span class="st">&#39;var&#39;</span></span>
<span id="cb43-226"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-226" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.prepare_data_var(stock_list, col)</span>
<span id="cb43-227"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-227" tabindex="-1"></a>        df_all, train, test, train_idx, test_idx, stock_cols, cols, scaler_list <span class="op">=</span> output</span>
<span id="cb43-228"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-228" tabindex="-1"></a></span>
<span id="cb43-229"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-229" tabindex="-1"></a>        model <span class="op">=</span> VAR(train[cols])</span>
<span id="cb43-230"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-230" tabindex="-1"></a>        result <span class="op">=</span> model.fit(maxlags<span class="op">=</span><span class="dv">40</span>, method<span class="op">=</span><span class="st">&#39;mle&#39;</span>, ic<span class="op">=</span><span class="st">&#39;aic&#39;</span>)</span>
<span id="cb43-231"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-231" tabindex="-1"></a></span>
<span id="cb43-232"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-232" tabindex="-1"></a>        lag_order <span class="op">=</span> result.k_ar</span>
<span id="cb43-233"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-233" tabindex="-1"></a>        prior <span class="op">=</span> train.iloc[<span class="op">-</span>lag_order:][cols].to_numpy()</span>
<span id="cb43-234"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-234" tabindex="-1"></a>        forecast_df <span class="op">=</span> pd.DataFrame(result.forecast(prior, N_TEST), columns<span class="op">=</span>cols)</span>
<span id="cb43-235"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-235" tabindex="-1"></a></span>
<span id="cb43-236"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-236" tabindex="-1"></a>        train_idx[:lag_order] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb43-237"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-237" tabindex="-1"></a></span>
<span id="cb43-238"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-238" tabindex="-1"></a>        <span class="co"># index &quot;0&quot; for the first stock (UAL). Can modify to be more generic</span></span>
<span id="cb43-239"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-239" tabindex="-1"></a>        scaler <span class="op">=</span> scaler_list[<span class="dv">0</span>]</span>
<span id="cb43-240"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-240" tabindex="-1"></a>        fitted_scaled <span class="op">=</span> result.fittedvalues[cols[<span class="dv">0</span>]]</span>
<span id="cb43-241"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-241" tabindex="-1"></a>        fitted <span class="op">=</span> scaler.inverse_transform(np.reshape(fitted_scaled, (<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)))</span>
<span id="cb43-242"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-242" tabindex="-1"></a>        forecast_scaled <span class="op">=</span> forecast_df[cols[<span class="dv">0</span>]].values</span>
<span id="cb43-243"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-243" tabindex="-1"></a>        forecast <span class="op">=</span> scaler.inverse_transform(np.reshape(forecast_scaled, (<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)))</span>
<span id="cb43-244"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-244" tabindex="-1"></a></span>
<span id="cb43-245"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-245" tabindex="-1"></a>        df_all.loc[train_idx, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_fitted&quot;</span>] <span class="op">=</span> fitted</span>
<span id="cb43-246"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-246" tabindex="-1"></a>        df_all.loc[test_idx, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_forecast&quot;</span>] <span class="op">=</span> forecast</span>
<span id="cb43-247"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-247" tabindex="-1"></a></span>
<span id="cb43-248"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-248" tabindex="-1"></a>        <span class="va">self</span>.result_for_plot <span class="op">=</span> <span class="va">self</span>.result_for_plot.merge(df_all[[<span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_fitted&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_forecast&quot;</span>]],</span>
<span id="cb43-249"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-249" tabindex="-1"></a>                                                          left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb43-250"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-250" tabindex="-1"></a>                                                          right_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-251"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-251" tabindex="-1"></a></span>
<span id="cb43-252"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-252" tabindex="-1"></a>        col <span class="op">=</span> stock_cols[<span class="dv">0</span>]</span>
<span id="cb43-253"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-253" tabindex="-1"></a>        plot_fitted_forecast(df_all, <span class="st">&#39;var&#39;</span>, col)</span>
<span id="cb43-254"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-254" tabindex="-1"></a></span>
<span id="cb43-255"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-255" tabindex="-1"></a>        <span class="co"># Calculate R2</span></span>
<span id="cb43-256"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-256" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;VAR Train R2: &quot;</span>, r2_score(df_all.loc[train_idx, cols[<span class="dv">0</span>]].iloc[lag_order:],</span>
<span id="cb43-257"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-257" tabindex="-1"></a>                                         df_all.loc[train_idx, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_fitted&quot;</span>].iloc[lag_order:]))</span>
<span id="cb43-258"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-258" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;VAR Test R2: &quot;</span>, r2_score(df_all.loc[test_idx, cols[<span class="dv">0</span>]],</span>
<span id="cb43-259"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-259" tabindex="-1"></a>                                        df_all.loc[test_idx, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_forecast&quot;</span>]))</span>
<span id="cb43-260"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-260" tabindex="-1"></a></span>
<span id="cb43-261"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-261" tabindex="-1"></a>    <span class="kw">def</span> run_arima(<span class="va">self</span>, stock_name<span class="op">=</span><span class="st">&#39;UAL&#39;</span>, col<span class="op">=</span><span class="st">&#39;Close&#39;</span>, seasonal<span class="op">=</span><span class="va">True</span>, m<span class="op">=</span><span class="dv">12</span>):</span>
<span id="cb43-262"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-262" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb43-263"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-263" tabindex="-1"></a><span class="co">        Run the Auto Autoregressive Integrated Moving Average (ARIMA) model on the specified stock.</span></span>
<span id="cb43-264"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-264" tabindex="-1"></a></span>
<span id="cb43-265"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-265" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb43-266"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-266" tabindex="-1"></a><span class="co">            stock_name (str): The name of the stock. Default is &#39;UAL&#39;.</span></span>
<span id="cb43-267"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-267" tabindex="-1"></a><span class="co">            col (str): The column name to use for the model. Default is &#39;Close&#39;.</span></span>
<span id="cb43-268"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-268" tabindex="-1"></a><span class="co">            seasonal (bool): Whether to include seasonal components. Default is True.</span></span>
<span id="cb43-269"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-269" tabindex="-1"></a><span class="co">            m (int): The number of periods in each seasonal cycle. Default is 12.</span></span>
<span id="cb43-270"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-270" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb43-271"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-271" tabindex="-1"></a>        name <span class="op">=</span> <span class="st">&#39;arima&#39;</span></span>
<span id="cb43-272"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-272" tabindex="-1"></a>        df_all <span class="op">=</span> <span class="va">self</span>.dfs[stock_name]</span>
<span id="cb43-273"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-273" tabindex="-1"></a>        train, test, train_idx, test_idx <span class="op">=</span> prepare_data(df_all)</span>
<span id="cb43-274"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-274" tabindex="-1"></a></span>
<span id="cb43-275"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-275" tabindex="-1"></a>        plot_acf(train[col])</span>
<span id="cb43-276"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-276" tabindex="-1"></a>        plt.savefig(<span class="st">&quot;acf.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb43-277"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-277" tabindex="-1"></a>        plot_pacf(train[col])</span>
<span id="cb43-278"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-278" tabindex="-1"></a>        plt.savefig(<span class="st">&quot;pacf.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb43-279"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-279" tabindex="-1"></a></span>
<span id="cb43-280"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-280" tabindex="-1"></a>        model <span class="op">=</span> pm.auto_arima(train[col], trace<span class="op">=</span><span class="va">True</span>, suppress_warnings<span class="op">=</span><span class="va">True</span>, seasonal<span class="op">=</span>seasonal, m<span class="op">=</span>m)</span>
<span id="cb43-281"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-281" tabindex="-1"></a></span>
<span id="cb43-282"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-282" tabindex="-1"></a>        <span class="bu">print</span>(model.summary())</span>
<span id="cb43-283"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-283" tabindex="-1"></a></span>
<span id="cb43-284"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-284" tabindex="-1"></a>        df_all.loc[train_idx, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_fitted&quot;</span>] <span class="op">=</span> model.predict_in_sample(end<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb43-285"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-285" tabindex="-1"></a>        df_all.loc[test_idx, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_forecast&quot;</span>] <span class="op">=</span> np.array(model.predict(n_periods<span class="op">=</span>N_TEST, return_conf_int<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb43-286"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-286" tabindex="-1"></a></span>
<span id="cb43-287"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-287" tabindex="-1"></a>        <span class="va">self</span>.result_for_plot <span class="op">=</span> <span class="va">self</span>.result_for_plot.merge(df_all[[<span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_fitted&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_forecast&quot;</span>]],</span>
<span id="cb43-288"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-288" tabindex="-1"></a>                                                          left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb43-289"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-289" tabindex="-1"></a>                                                          right_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-290"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-290" tabindex="-1"></a></span>
<span id="cb43-291"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-291" tabindex="-1"></a>        plot_fitted_forecast(df_all, <span class="st">&#39;arima&#39;</span>, col)</span>
<span id="cb43-292"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-292" tabindex="-1"></a></span>
<span id="cb43-293"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-293" tabindex="-1"></a>    <span class="kw">def</span> plot_result_comparison(<span class="va">self</span>, stock_name<span class="op">=</span><span class="st">&#39;UAL&#39;</span>, col<span class="op">=</span><span class="st">&#39;Log&#39;</span>):</span>
<span id="cb43-294"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-294" tabindex="-1"></a>        <span class="va">self</span>.result_for_plot <span class="op">=</span> <span class="va">self</span>.result_for_plot.merge(<span class="va">self</span>.dfs[stock_name][col],</span>
<span id="cb43-295"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-295" tabindex="-1"></a>                                                          left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb43-296"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-296" tabindex="-1"></a>                                                          right_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-297"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-297" tabindex="-1"></a></span>
<span id="cb43-298"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-298" tabindex="-1"></a>        colors <span class="op">=</span> [<span class="st">&#39;red&#39;</span>, <span class="st">&#39;red&#39;</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;orange&#39;</span>, <span class="st">&#39;orange&#39;</span>, <span class="st">&#39;pink&#39;</span>]</span>
<span id="cb43-299"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-299" tabindex="-1"></a>        line_styles <span class="op">=</span> [<span class="st">&#39;:&#39;</span>, <span class="st">&#39;--&#39;</span>, <span class="st">&#39;:&#39;</span>, <span class="st">&#39;--&#39;</span>, <span class="st">&#39;:&#39;</span>, <span class="st">&#39;--&#39;</span>, <span class="st">&#39;-&#39;</span>]</span>
<span id="cb43-300"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-300" tabindex="-1"></a>        legend_names <span class="op">=</span> [<span class="st">&#39;ETS Fitted Values&#39;</span>, <span class="st">&#39;ETS Forecast&#39;</span>,</span>
<span id="cb43-301"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-301" tabindex="-1"></a>                        <span class="st">&#39;VAR Fitted Values&#39;</span>, <span class="st">&#39;VAR Forecast&#39;</span>,</span>
<span id="cb43-302"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-302" tabindex="-1"></a>                        <span class="st">&#39;ARIMA Fitted Values&#39;</span>, <span class="st">&#39;ARIMA Forecast&#39;</span>,</span>
<span id="cb43-303"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-303" tabindex="-1"></a>                        <span class="st">&#39;Data (in log)&#39;</span>]</span>
<span id="cb43-304"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-304" tabindex="-1"></a></span>
<span id="cb43-305"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-305" tabindex="-1"></a>        <span class="va">self</span>.result_for_plot[<span class="op">-</span><span class="dv">27</span>:].plot(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>),</span>
<span id="cb43-306"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-306" tabindex="-1"></a>                                        color<span class="op">=</span>colors, style<span class="op">=</span>line_styles, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-307"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-307" tabindex="-1"></a>        plt.legend(labels<span class="op">=</span>legend_names)</span>
<span id="cb43-308"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-308" tabindex="-1"></a>        plt.savefig(<span class="st">&quot;comparison_ts.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb43-309"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-309" tabindex="-1"></a></span>
<span id="cb43-310"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-310" tabindex="-1"></a></span>
<span id="cb43-311"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-311" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb43-312"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-312" tabindex="-1"></a>    <span class="co"># parameters</span></span>
<span id="cb43-313"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-313" tabindex="-1"></a>    STOCK <span class="op">=</span> <span class="st">&#39;UAL&#39;</span></span>
<span id="cb43-314"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-314" tabindex="-1"></a>    COL <span class="op">=</span> <span class="st">&#39;Log&#39;</span></span>
<span id="cb43-315"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-315" tabindex="-1"></a>    N_TEST <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb43-316"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-316" tabindex="-1"></a>    H <span class="op">=</span> <span class="dv">20</span>  <span class="co"># 4 weeks</span></span>
<span id="cb43-317"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-317" tabindex="-1"></a>    STEPS <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb43-318"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-318" tabindex="-1"></a></span>
<span id="cb43-319"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-319" tabindex="-1"></a>    ts <span class="op">=</span> StocksForecast()</span>
<span id="cb43-320"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-320" tabindex="-1"></a></span>
<span id="cb43-321"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-321" tabindex="-1"></a>    ts.run_ets(stock_name<span class="op">=</span>STOCK, col<span class="op">=</span>COL)</span>
<span id="cb43-322"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-322" tabindex="-1"></a>    ts.run_var(col<span class="op">=</span>COL)</span>
<span id="cb43-323"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-323" tabindex="-1"></a>    ts.run_arima(stock_name<span class="op">=</span>STOCK, col<span class="op">=</span>COL)</span>
<span id="cb43-324"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-324" tabindex="-1"></a></span>
<span id="cb43-325"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-325" tabindex="-1"></a>    ts.plot_result_comparison()</span>
<span id="cb43-326"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-326" tabindex="-1"></a></span>
<span id="cb43-327"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-327" tabindex="-1"></a>    <span class="co"># Hyperparameters to try in ETS walk-forward validation</span></span>
<span id="cb43-328"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-328" tabindex="-1"></a>    trend_type_list <span class="op">=</span> [<span class="st">&#39;add&#39;</span>, <span class="st">&#39;mul&#39;</span>]</span>
<span id="cb43-329"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-329" tabindex="-1"></a>    seasonal_type_list <span class="op">=</span> [<span class="st">&#39;add&#39;</span>, <span class="st">&#39;mul&#39;</span>]</span>
<span id="cb43-330"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-330" tabindex="-1"></a>    init_method_list <span class="op">=</span> [<span class="st">&#39;estimated&#39;</span>, <span class="st">&#39;heuristic&#39;</span>, <span class="st">&#39;legacy-heristic&#39;</span>]  <span class="co"># not used</span></span>
<span id="cb43-331"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-331" tabindex="-1"></a>    use_boxcox_list <span class="op">=</span> [<span class="va">True</span>, <span class="va">False</span>, <span class="dv">0</span>]  <span class="co"># not used</span></span>
<span id="cb43-332"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-332" tabindex="-1"></a></span>
<span id="cb43-333"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-333" tabindex="-1"></a>    tuple_of_option_lists <span class="op">=</span> (trend_type_list, seasonal_type_list,)</span>
<span id="cb43-334"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-334" tabindex="-1"></a>    ts.run_walkforward(H, STEPS, STOCK, COL, tuple_of_option_lists)</span>
<span id="cb43-335"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-335" tabindex="-1"></a></span>
<span id="cb43-336"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-336" tabindex="-1"></a><span class="co"># Other things that may be of interest:</span></span>
<span id="cb43-337"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-337" tabindex="-1"></a><span class="co"># boxcox: from scipy.stats import boxcox</span></span>
<span id="cb43-338"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-338" tabindex="-1"></a><span class="co"># Test for stationarity: from statsmodels.tsa.stattools import adfuller</span></span>
<span id="cb43-339"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-339" tabindex="-1"></a><span class="co"># VARMAX: from statsmodels.tsa.statespace.varmax import VARMAX</span></span>
<span id="cb43-340"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb43-340" tabindex="-1"></a><span class="co"># ARIMA: from statsmodels.tsa.arima.model import ARIMA</span></span></code></pre></div>
</details>
<p>As in other chapters, a <code>class</code>, named <code>StocksForecast</code>, is written. In the beginning of the script, we have two static methods/functions outside of the class for data preparation and plotting. For <code>StockForecast</code>, we initiate the class with:</p>
<ol style="list-style-type: decimal">
<li>download the data</li>
<li>store data into a <code>dictionary</code> with each stock in a different key</li>
<li>calculate the log and first-differenced values of <code>close price</code>.</li>
</ol>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-1" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, stock_name_list<span class="op">=</span>(<span class="st">&#39;UAL&#39;</span>, <span class="st">&#39;WMT&#39;</span>, <span class="st">&#39;PFE&#39;</span>), start_date<span class="op">=</span><span class="st">&#39;2018-01-01&#39;</span>, end_date<span class="op">=</span><span class="st">&#39;2022-12-31&#39;</span>):</span>
<span id="cb44-2"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-2" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb44-3"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-3" tabindex="-1"></a><span class="co">        Initialize the StocksForecast class.</span></span>
<span id="cb44-4"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-4" tabindex="-1"></a></span>
<span id="cb44-5"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-5" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb44-6"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-6" tabindex="-1"></a><span class="co">            stock_name_list (list[str]): List of stock names. Default is (&#39;UAL&#39;, &#39;WMT&#39;, &#39;PFE&#39;).</span></span>
<span id="cb44-7"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-7" tabindex="-1"></a><span class="co">            start_date (str): Start date of the data. Default is &#39;2018-01-01&#39;.</span></span>
<span id="cb44-8"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-8" tabindex="-1"></a><span class="co">            end_date (str): End date of the data. Default is &#39;2022-12-31&#39;.</span></span>
<span id="cb44-9"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-9" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb44-10"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-10" tabindex="-1"></a>        <span class="va">self</span>.dfs <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb44-11"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-11" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> stock_name_list:</span>
<span id="cb44-12"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-12" tabindex="-1"></a>            <span class="va">self</span>.dfs[name] <span class="op">=</span> yf.download(name, start<span class="op">=</span>start_date, end<span class="op">=</span>end_date)</span>
<span id="cb44-13"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-13" tabindex="-1"></a>            <span class="va">self</span>.dfs[name][<span class="st">&#39;Diff&#39;</span>] <span class="op">=</span> <span class="va">self</span>.dfs[name][<span class="st">&#39;Close&#39;</span>].diff(<span class="dv">1</span>)</span>
<span id="cb44-14"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-14" tabindex="-1"></a>            <span class="va">self</span>.dfs[name][<span class="st">&#39;Log&#39;</span>] <span class="op">=</span> np.log(<span class="va">self</span>.dfs[name][<span class="st">&#39;Close&#39;</span>])</span>
<span id="cb44-15"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-15" tabindex="-1"></a></span>
<span id="cb44-16"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb44-16" tabindex="-1"></a>        <span class="va">self</span>.result_for_plot <span class="op">=</span> pd.DataFrame(index<span class="op">=</span><span class="va">self</span>.dfs[stock_name_list[<span class="dv">0</span>]].index)</span></code></pre></div>
</details>
<p>Each model is implemented inside a wrapper function. For example, the ETS implementation is in <code>run_ets()</code>, which does the following:</p>
<ol style="list-style-type: decimal">
<li>call the <code>prepare_data()</code> function</li>
<li>instantiate the <code>ExponentialSmoothing</code> model from <code>statsmodels</code> with hyperparameters <code>trend</code>, <code>seasonal</code>, and <code>seasonal_periods</code>. For <code>trend</code> and <code>seasonal</code>, <code>mul</code> means these trends are multiplicative. The value 252 (days) is used for <code>seasonal_periods</code> since this is about the number of trading days in half a year</li>
<li>call <code>model.fit()</code></li>
<li>get forecast columns and prepare the data for plotting</li>
<li>call the <code>plot_fitted_forecast()</code> function to plot</li>
</ol>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb45"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-1" tabindex="-1"></a>    <span class="kw">def</span> run_ets(<span class="va">self</span>, stock_name<span class="op">=</span><span class="st">&#39;UAL&#39;</span>, col<span class="op">=</span><span class="st">&#39;Close&#39;</span>):</span>
<span id="cb45-2"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-2" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb45-3"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-3" tabindex="-1"></a><span class="co">        Run the Exponential Smoothing (ETS) model on the specified stock.</span></span>
<span id="cb45-4"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-4" tabindex="-1"></a></span>
<span id="cb45-5"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-5" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb45-6"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-6" tabindex="-1"></a><span class="co">            stock_name (str): The name of the stock. Default is &#39;UAL&#39;.</span></span>
<span id="cb45-7"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-7" tabindex="-1"></a><span class="co">            col (str): The column name to use for the model. Default is &#39;Close&#39;.</span></span>
<span id="cb45-8"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-8" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb45-9"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-9" tabindex="-1"></a>        name <span class="op">=</span> <span class="st">&#39;ets&#39;</span></span>
<span id="cb45-10"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-10" tabindex="-1"></a></span>
<span id="cb45-11"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-11" tabindex="-1"></a>        df_all <span class="op">=</span> <span class="va">self</span>.dfs[stock_name]</span>
<span id="cb45-12"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-12" tabindex="-1"></a>        train, test, train_idx, test_idx <span class="op">=</span> prepare_data(df_all)</span>
<span id="cb45-13"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-13" tabindex="-1"></a></span>
<span id="cb45-14"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-14" tabindex="-1"></a>        model <span class="op">=</span> ExponentialSmoothing(train[col].dropna(), trend<span class="op">=</span><span class="st">&#39;mul&#39;</span>, seasonal<span class="op">=</span><span class="st">&#39;mul&#39;</span>, seasonal_periods<span class="op">=</span><span class="dv">252</span>)</span>
<span id="cb45-15"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-15" tabindex="-1"></a>        result <span class="op">=</span> model.fit()</span>
<span id="cb45-16"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-16" tabindex="-1"></a></span>
<span id="cb45-17"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-17" tabindex="-1"></a>        df_all.loc[train_idx, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_fitted&quot;</span>] <span class="op">=</span> result.fittedvalues</span>
<span id="cb45-18"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-18" tabindex="-1"></a>        df_all.loc[test_idx, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_forecast&quot;</span>] <span class="op">=</span> np.array(result.forecast(N_TEST))</span>
<span id="cb45-19"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-19" tabindex="-1"></a></span>
<span id="cb45-20"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-20" tabindex="-1"></a>        <span class="va">self</span>.result_for_plot <span class="op">=</span> <span class="va">self</span>.result_for_plot.merge(df_all[[<span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_fitted&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_forecast&quot;</span>]],</span>
<span id="cb45-21"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-21" tabindex="-1"></a>                                                          left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb45-22"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-22" tabindex="-1"></a>                                                          right_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb45-23"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-23" tabindex="-1"></a></span>
<span id="cb45-24"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb45-24" tabindex="-1"></a>        plot_fitted_forecast(df_all, <span class="st">&#39;ets&#39;</span>, col)</span></code></pre></div>
</details>
<p>A walk-forward validation for ETS is implemented by the method <code>run_walkforward()</code> (largely from the Lazy Programmer) which is a wrapper function of <code>warlkforward_ets()</code>. For time series data, we can not perform cross-validation by selecting a random subset of observations, as this can result in using future values to predict past value. Instead, a n-step walk-forward validation should be used. Suppose we have data from 1/1/2018 to 12/31/2022, a 1-step walk-forward validation using data from December 2022 would involve the following steps:</p>
<ol style="list-style-type: decimal">
<li>train the model with data from 1/1/2018 to 11/30/2022</li>
<li>with model result, make prediction for 12/1/2022</li>
<li>compare the true and predicted values and calculate the error or other desire metric(s)</li>
<li>“walk forward” by 1 day, then go back to training the model, i.e., train the model with data from 1/1/2018 to 12/1/2022</li>
<li>continue until data from 1/1/2018 to 12/30/2022 is used for training and 12/31/2022 is predicted</li>
</ol>
<p>We should try several different hyperparameter combinations since the purpose of the walk-forward validation is to choose the “best” hyperparameters. The following lines inside <code>if __name__ == "__main__":</code> calls the <code>run_walkforward()</code> method to try a combination of hyperparameters, which also prints out the “best” values for <code>trend</code> and <code>seasonal</code>:</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb46-1" tabindex="-1"></a>    <span class="co"># Hyperparameters to try in ETS walk-forward validation</span></span>
<span id="cb46-2"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb46-2" tabindex="-1"></a>    trend_type_list <span class="op">=</span> [<span class="st">&#39;add&#39;</span>, <span class="st">&#39;mul&#39;</span>]</span>
<span id="cb46-3"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb46-3" tabindex="-1"></a>    seasonal_type_list <span class="op">=</span> [<span class="st">&#39;add&#39;</span>, <span class="st">&#39;mul&#39;</span>]</span>
<span id="cb46-4"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb46-4" tabindex="-1"></a>    init_method_list <span class="op">=</span> [<span class="st">&#39;estimated&#39;</span>, <span class="st">&#39;heuristic&#39;</span>, <span class="st">&#39;legacy-heristic&#39;</span>]  <span class="co"># not used</span></span>
<span id="cb46-5"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb46-5" tabindex="-1"></a>    use_boxcox_list <span class="op">=</span> [<span class="va">True</span>, <span class="va">False</span>, <span class="dv">0</span>]  <span class="co"># not used</span></span>
<span id="cb46-6"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb46-6" tabindex="-1"></a></span>
<span id="cb46-7"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb46-7" tabindex="-1"></a>    tuple_of_option_lists <span class="op">=</span> (trend_type_list, seasonal_type_list,)</span>
<span id="cb46-8"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb46-8" tabindex="-1"></a>    ts.run_walkforward(H, STEPS, STOCK, COL, tuple_of_option_lists)</span></code></pre></div>
</details>
<p>The method <code>run_var()</code> runs the VAR model. Since we run VAR with several stocks, standardized/normalized should be performed. This is accomplished in the <code>prepare_data_var()</code> method with <code>StandardScaler()</code> from scikit-learn.</p>
<p>Last but not least, the <code>run_arima()</code> method runs the Auto ARIMA from the <code>pdmarima</code> library. Here, we also call <code>plot_acf()</code> and <code>plot_pacf()</code> from scikit-learn to examine the autocorrelation and partial autocorrelation functions. Normally, they are important for the ARIMA model. However, with Auto ARIMA, we are spared of the task of manually determine the values of AR() and MA(). Similar to <code>run_ets()</code>, there are only a few lines of code:</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-1" tabindex="-1"></a>    <span class="kw">def</span> run_arima(<span class="va">self</span>, stock_name<span class="op">=</span><span class="st">&#39;UAL&#39;</span>, col<span class="op">=</span><span class="st">&#39;Close&#39;</span>, seasonal<span class="op">=</span><span class="va">True</span>, m<span class="op">=</span><span class="dv">12</span>):</span>
<span id="cb47-2"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-2" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb47-3"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-3" tabindex="-1"></a><span class="co">        Run the Auto Autoregressive Integrated Moving Average (ARIMA) model on the specified stock.</span></span>
<span id="cb47-4"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-4" tabindex="-1"></a></span>
<span id="cb47-5"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-5" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb47-6"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-6" tabindex="-1"></a><span class="co">            stock_name (str): The name of the stock. Default is &#39;UAL&#39;.</span></span>
<span id="cb47-7"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-7" tabindex="-1"></a><span class="co">            col (str): The column name to use for the model. Default is &#39;Close&#39;.</span></span>
<span id="cb47-8"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-8" tabindex="-1"></a><span class="co">            seasonal (bool): Whether to include seasonal components. Default is True.</span></span>
<span id="cb47-9"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-9" tabindex="-1"></a><span class="co">            m (int): The number of periods in each seasonal cycle. Default is 12.</span></span>
<span id="cb47-10"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-10" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb47-11"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-11" tabindex="-1"></a>        name <span class="op">=</span> <span class="st">&#39;arima&#39;</span></span>
<span id="cb47-12"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-12" tabindex="-1"></a>        df_all <span class="op">=</span> <span class="va">self</span>.dfs[stock_name]</span>
<span id="cb47-13"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-13" tabindex="-1"></a>        train, test, train_idx, test_idx <span class="op">=</span> prepare_data(df_all)</span>
<span id="cb47-14"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-14" tabindex="-1"></a></span>
<span id="cb47-15"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-15" tabindex="-1"></a>        plot_acf(train[col])</span>
<span id="cb47-16"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-16" tabindex="-1"></a>        plt.savefig(<span class="st">&quot;acf.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb47-17"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-17" tabindex="-1"></a>        plot_pacf(train[col])</span>
<span id="cb47-18"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-18" tabindex="-1"></a>        plt.savefig(<span class="st">&quot;pacf.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb47-19"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-19" tabindex="-1"></a></span>
<span id="cb47-20"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-20" tabindex="-1"></a>        model <span class="op">=</span> pm.auto_arima(train[col], trace<span class="op">=</span><span class="va">True</span>, suppress_warnings<span class="op">=</span><span class="va">True</span>, seasonal<span class="op">=</span>seasonal, m<span class="op">=</span>m)</span>
<span id="cb47-21"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-21" tabindex="-1"></a></span>
<span id="cb47-22"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-22" tabindex="-1"></a>        <span class="bu">print</span>(model.summary())</span>
<span id="cb47-23"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-23" tabindex="-1"></a></span>
<span id="cb47-24"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-24" tabindex="-1"></a>        df_all.loc[train_idx, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_fitted&quot;</span>] <span class="op">=</span> model.predict_in_sample(end<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb47-25"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-25" tabindex="-1"></a>        df_all.loc[test_idx, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_forecast&quot;</span>] <span class="op">=</span> np.array(model.predict(n_periods<span class="op">=</span>N_TEST, return_conf_int<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb47-26"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-26" tabindex="-1"></a></span>
<span id="cb47-27"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-27" tabindex="-1"></a>        <span class="va">self</span>.result_for_plot <span class="op">=</span> <span class="va">self</span>.result_for_plot.merge(df_all[[<span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_fitted&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_forecast&quot;</span>]],</span>
<span id="cb47-28"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-28" tabindex="-1"></a>                                                          left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb47-29"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-29" tabindex="-1"></a>                                                          right_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-30"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-30" tabindex="-1"></a></span>
<span id="cb47-31"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb47-31" tabindex="-1"></a>        plot_fitted_forecast(df_all, <span class="st">&#39;arima&#39;</span>, col)</span></code></pre></div>
</details>
<p>The plots of ACF and PACF are as follow:</p>
<p><img src="images/acf.png" />
<img src="images/pacf.png" /></p>
<p>If you would like to run ARIMA from <code>statsmodels</code>, you can import <code>ARIMA</code> from <code>statsmodels.tsa.arima.model</code>. <code>statsmodels</code> also provides functions and APIs for other time-series/forecasting methods and models. For example, you can test for stationarity with the augmented Dickey-Fuller unit root test by importing <code>adfuller</code> from <code>statsmodels.tsa.stattools</code>, or run the Vector Autoregressive Moving Average with exogenous regressors by importing <code>VARMAX</code> from <code>statsmodels.tsa.statespace.varmax</code>. In addition, if you would like to do the Box-Cox transformation, you can import <code>boxcox</code> from <code>scipy.stats</code>.</p>
<p>The last method in the <code>StocksForecast</code> class produces the following comparison plot. None of the models along performed particularly good. Surprisingly, and now shown in this plot, the average of the three models would predict quite well. This, once again, shows the power of ensemble or meta-learning.</p>
<p><img src="images/comparison_ts.png" /></p>
</div>
<div id="artificial-neural-network-ann" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Artificial Neural Network (ANN)<a href="time-series-forecasting-and-deep-learning-algorithms.html#artificial-neural-network-ann" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Similar to other chapters, this chapter assumes that readers have some idea about what a neural network is and what it can do. Our goal is not to give an in-depth introduction to neural networks. Rather, we will only cover elements of neural networks that matter most in their applications in economics and business assuming readers already have some quantitative training. An excellent place that you can “play” with a neural network model is the <a href="https://playground.tensorflow.org/">Tensorflow Playground</a>.</p>
<p>Neural networks can be used on both regression and classification problems. Our focus in this chapter is to use neural networks on regression since the emphasis is forecasting. Keep in mind that we can always reshape a regression problem into a classification problem. For example, instead of forecasting the actual price or return of a stock, we can predict the likelihood of a stock trending up or down, which is a binary classification problem. The difference between applying neural networks on regression or classification problems is minor: for regression problems, the final activation function is an identify function (returns itself) whereas for classification problems it is Sigmoid or other functions that return values between 0 and 1. A really good summary of activation functions is <a href="https://stats.stackexchange.com/questions/115258/comprehensive-list-of-activation-functions-in-neural-networks-with-pros-cons">this answer on stackexchange</a>.</p>
<p>Let us begin with artificial neural network (ANN). For implementation of neural networks, we are using <code>Keras</code> (<a href="https://keras.io/" class="uri">https://keras.io/</a>) from <code>Tensorflow</code> (<a href="https://www.tensorflow.org/" class="uri">https://www.tensorflow.org/</a>). We will introduce <code>PyTorch</code>, another popular deep learning library, in other chapters.</p>
<p>Neural network models intend to mimic the human brain. The basic idea can be described as follow. Imagine you see an ice-cream truck and decide to try an ice-cream that you have not had before. First, you receive multiple signals: you see the brand, shape, color, and possibly smell and ingredients of many ice-creams that you can choose from. These “raw” signals are first passed through the initial layer of neurons, the ones immediately connected to your eyes and noses and other sensory organs. After the initial layer and processing, you recognize different features of many ice-creams, some excites you, some not. In neural science terminology, the outputs from the first layer of neurons have different “action potential”. If the action potential passes a certain threshold, it excites you. But such excitement can be both positive and negative. For example, you may recognize there are peanuts in some of the ice-creams cones. While the crunchy cone excites you, you also know that you are allergic to peanuts. Imagine in the second layer, one neuron specializes in recognizing cones and the other peanuts. The output from the first layer would activate both of these two neurons. And hence the name “activation function”. This process can continue. A neural network may contain many layers, and each layer many neurons. After passing through all the layers, you have arrived at your decision: A cup with vanilla and strawberry ice-creams and chocolate chips on top.</p>
<p>Suppose your raw data set has <span class="math inline">\(N\)</span> observations/rows and <span class="math inline">\(M\)</span> features/columns. The probability of the <span class="math inline">\(i\)</span>’s neuron in the first layer being activated is</p>
<p><span class="math display">\[z^{(1)}_i=p(\text{activated} \mid x)=\sigma(xW^{(1)}_i+b^{(1)}_i)\]</span></p>
<p>where <span class="math inline">\(x\)</span> is a <span class="math inline">\(N\times M\)</span> matrix, <span class="math inline">\(W^{(1)}_i\)</span> and <span class="math inline">\(b^{(1)}_i\)</span> are both vectors of size <span class="math inline">\(M\)</span>, and <span class="math inline">\(\sigma()\)</span> is an activation function that returns a probability such as Sigmoid or ReLU. In regression terminology, <span class="math inline">\(W^{(1)}_i\)</span> are the coefficients and <span class="math inline">\(b^{(1)}_i\)</span> is the intercept. By neural network convention, we use the superscript <span class="math inline">\((j)\)</span> to denote layer.</p>
<p>Usually each layer has multiple neurons. In this case, the outputs <span class="math inline">\(z^{(j)}_i\)</span> can be “stacked” horizontally and fed into the next lay. We an similarly stack <span class="math inline">\(W^{(j)}_i\)</span> and <span class="math inline">\(b^{(j)}_i\)</span>. In other words, the number of neurons in the current layer (<span class="math inline">\(j\)</span>) is the number of features for the next layer layer (<span class="math inline">\(j+1\)</span>). With this, we can express the whole neural network in the following manner:</p>
<ul>
<li>Beginning (<span class="math inline">\(j=1\)</span>): <span class="math inline">\(z^{(1)}=\sigma(xW^{(1)}+b^{(1)})\)</span></li>
<li>Hidden layers (<span class="math inline">\(1&lt;j&lt;J\)</span>): <span class="math inline">\(z^{(j)}=\sigma(z^{(j-1)}W^{(j)}+b^{(j)})\)</span></li>
<li>Final layer (<span class="math inline">\(j=J\)</span>): <span class="math inline">\(\hat{y}=z^{(L-1)}W^{(L)}+b^{(L)}\)</span></li>
</ul>
<p>where <span class="math inline">\(J\)</span> denotes the total number of layers, and <span class="math inline">\(\hat{y}\)</span> is the prediction. Note that the final layer does not have an activation function here because we are dealing with a regression model.</p>
<p>While Sigmoid is a widely used function when probabilities are to be predicted, it suffers from the <a href="https://en.wikipedia.org/wiki/Vanishing_gradient_problem">vanishing gradient problem</a> especially with deep (many layers) neural networks. Modern deep learning models often use <code>ReLU</code> or <code>tanh</code> as the activation function for inner layers. Again, see <a href="https://stats.stackexchange.com/questions/115258/comprehensive-list-of-activation-functions-in-neural-networks-with-pros-cons">this answer on stackexchange</a> for the pros and cons of different activation functions in neural networks.</p>
</div>
<div id="recurrent-neural-network-rnn" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Recurrent Neural Network (RNN)<a href="time-series-forecasting-and-deep-learning-algorithms.html#recurrent-neural-network-rnn" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>There is a compelling reason why <code>Recurrent Neural Network</code> (RNN) models are often expected to perform well in time-series/forecasting tasks: it is the neural network version of the autoregressive (AR) process. in its simplest form, often referred to as <code>Simple RNN</code>, the output from the hidden layers of time <span class="math inline">\(t-1\)</span> is used as inputs for time <span class="math inline">\(t\)</span> in addition to <span class="math inline">\(x\)</span>.</p>
<p>Suppose you only care about one-step forecast, i.e., you want to predict <span class="math inline">\(t+1\)</span> with data up to time <span class="math inline">\(t\)</span>. Suppose we use all data for training, the approaches covered in this chapter so far have basically the same flavor: specify a single model for any length of time, train the model using data up to time <span class="math inline">\(t\)</span>, and make the prediction for <span class="math inline">\(t+1\)</span>. Even with walk-forward validation, it is not much different except that several values of <span class="math inline">\(t\)</span> are considered and hence the model was trained on different data and can have different parameters dependent on the value of <span class="math inline">\(t\)</span>.</p>
<p>Having a single unified model is often fine as long as the time series does not have large ups and downs. Unfortunately, economics and business time-series data only consists of ups and downs, such as a recession. In such cases, we often want to specify more than one model. That can be accomplished manually if we know exactly when a structural break has happened.</p>
<p>But life is a box of chocolates and every hour/day is different. It would be nice that a model can do the following: that it “remembers” the past and customizes a model for the current time.</p>
<p>RNN does exactly that. Concretely, let <span class="math inline">\(h_t\)</span> denote the <em>hidden state</em> of an RNN at time <span class="math inline">\(t\)</span>, we have</p>
<p><span class="math display">\[h_t = \sigma(h_{t-1}W_{ht} + x_tW_{xt}+b_{t})\]</span></p>
<p>where <span class="math inline">\(W_{ht}\)</span> and <span class="math inline">\(W_{xt}\)</span> are coefficients/weights for the hidden state and input <span class="math inline">\(x_t\)</span>, respectively, at time <span class="math inline">\(t\)</span>, and <span class="math inline">\(b_{t}(= b_{ht} + b_{xt})\)</span> is the intercept. The hidden state allows the model to “remember” the past and adds non-linear complexity to each time period. It should be noted that <span class="math inline">\(h_t\)</span> can be a mini ANN with many hidden layers.</p>
<p>In addition to Simple RNN, <code>Long Short-Term Member</code> (LSTM) and <code>Gated Recurrent Units</code> (GRU) are two widely used RNN models. Both models modified how hidden state is being remembered from one time period (or one state) to another. For GRU, two “gates” are introduced:</p>
<ul>
<li>Update gate: <span class="math inline">\(z_t = \sigma(x_tW_{xzt}+h_{t-1}W_{hzt}+b_{zt})\)</span></li>
<li>Reset gate: <span class="math inline">\(r_t = \sigma(x_tW_{xrt}+h_{t-1}W_{hrt}+b_{rt})\)</span></li>
</ul>
<p>And the hidden state is updated according to</p>
<p><span class="math display">\[h_t = (1-z_t)\odot h_{t-1} + z_t\odot \omega(x_tW_{xht}+(r_t\odot h_{t-1})W_{hht}+b_{ht})\]</span></p>
<p>where <span class="math inline">\(\odot\)</span> is an element-wise multiplication and <span class="math inline">\(\omega()\)</span> is an activation function similar to <span class="math inline">\(\sigma()\)</span> except that in Tensorflow the default is <code>tanh</code> instead of Sigmoid for RNN. In the GRU, <span class="math inline">\(z_t\)</span> controls how much the neural network “forgets” and <span class="math inline">\(r_t\)</span> controls how much the neural network “learns” from the previous state. If <span class="math inline">\(z_t=0\)</span>, then the neural network forgets about the previous state (since <span class="math inline">\(1-z_t=0\)</span>) and relearn. Keep in mind that the relearn, which is <span class="math inline">\(\omega()\)</span> still consists of the previous hidden state <span class="math inline">\(h_{t-1}\)</span> unless <span class="math inline">\(r_t\)</span> is also equal to 0.</p>
<p>For LSTM, we introduce a new state called <code>cell state</code> in addition to the hidden state. In practice, the cell state is an intermediate value that helps to keep track of the model is not included in calculating the final output. The LSTM has three gates:</p>
<ul>
<li>Forget gate: <span class="math inline">\(f_t = \sigma(x_tW_{xft}+h_{t-1}W_{hft}+b_{ft})\)</span></li>
<li>Input/Update gate: <span class="math inline">\(i_t = \sigma(x_tW_{xit}+h_{t-1}W_{hit}+b_{it})\)</span></li>
<li>Output gate: <span class="math inline">\(o_t = \sigma(x_tW_{xot}+h_{t-1}W_{hot}+b_{ot})\)</span></li>
</ul>
<p>And the hidden state and cell state (<span class="math inline">\(c_t\)</span>) are updated according to:</p>
<ul>
<li>Cell state: <span class="math inline">\(c_t = f_t\odot c_{t-1} + i_t\odot \omega(x_tW_{xct}+h_{t-1}W_{hct}+b_{ct})\)</span></li>
<li>Hidden state: <span class="math inline">\(h_t = o_t\odot \psi(c_t)\)</span></li>
</ul>
<p>Note that in Tensorflow, the activation function <span class="math inline">\(\omega()\)</span> and <span class="math inline">\(\psi()\)</span> can not be specified individually and are both defaulted to tanh.</p>
</div>
<div id="convolutional-neural-network-cnn" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> Convolutional Neural Network (CNN)<a href="time-series-forecasting-and-deep-learning-algorithms.html#convolutional-neural-network-cnn" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><code>Convolutional Neural Network</code> (CNN) is another deep learning algorithm that we can connect to traditional time-series/forecasting methods easily. Consider a typical ARIMA model, which has three parameters: <span class="math inline">\(p\)</span>, <span class="math inline">\(q\)</span>, and <span class="math inline">\(d\)</span>. These parameters dictates the number of periods in, respectively, autoregressive, moving average, and differencing. An alternative way to look at the ARIMA model is that the original time series data is transformed based on the three parameters.</p>
<p>There are other transformations and filters performed on time-series data, for example, Fourier transformation, low-pass filter, Baxter-King filter, to name a few. Exponential smoothing, which we have shown its implementation using <code>statsmodels</code> earlier, is also a filter. Differencing and autoregressive process are also filters.</p>
<p>Which brings us to CNN: convolving is applying filters on the data. The technical/mathematical details are less important for time-series data, as CNN is a widely used algorithm in computer vision (CV) and there are more nuances in that area. For our purpose, let us focus on the following aspects of CNN.</p>
<p>First, convolution does pattern matching/finding with cross-correlation. Imagine a time-series with length <span class="math inline">\(T=10\)</span>:</p>
<p><span class="math display">\[ts = [1, 4, 5, 3, 3, 4, 2, 3, 5, 3]\]</span></p>
<p>and another vector of length <span class="math inline">\(K=3\)</span>:</p>
<p><span class="math display">\[c = [1, 5, 1]\]</span></p>
<p>When we convolved <span class="math inline">\(ts\)</span> with <span class="math inline">\(c\)</span>, we are “sliding” <span class="math inline">\(c\)</span> over <span class="math inline">\(ts\)</span> and at each position, we compute the dot product. For example, when <span class="math inline">\(c\)</span> is overlaid on the first three values of <span class="math inline">\(ts\)</span>, we have:</p>
<p><span class="math display">\[[1, 5, 1] \cdot [1, 4, 5]=(1\times1)+(5\times4)+(1\times5)=26\]</span></p>
<p>Repeating this process, we get a convolved version of <span class="math inline">\(ts\)</span>:</p>
<p><span class="math display">\[tsv = [26, 32, 23, 22, 25, 17, 22, 31]\]</span></p>
<p>The resulted new vector is of size <span class="math inline">\(T-K+1\)</span>, which is the <code>valid</code> mode of convolution. If we want the resulted vector to be the same size as the original, we are performing a <code>same</code> mode convolution and we need to add padding of size <span class="math inline">\(K-1\)</span>. In our example, we can add two zeros to the original time series then do the convolution:</p>
<p><span class="math display">\[tsz = [0, 1, 4, 5, 3, 3, 4, 5, 6, 5, 3, 0]\]</span></p>
<p>How is convolution pattern matching/finding? In the above example, it easy to see that the filter <span class="math inline">\(c\)</span> has the pattern [low, high low]. In the above example, at locations 2nd and 6th, we have</p>
<p><span class="math display">\[ts_2 = [4, 5, 3]; \ ts_6 = [4, 2, 3]\]</span></p>
<p>The only difference is the value in the middle. It it straightforward to realize that the filter <span class="math inline">\(c\)</span> helps to identify a pattern that has [low, high, low] since <span class="math inline">\(c \cdot ts_2 &gt; c \cdot ts_6\)</span>.</p>
<p>But there is more. If we look at <span class="math inline">\(tsv\)</span>, we notice the two highest values are at locations 2nd and 8th:</p>
<p><span class="math display">\[ts_2 = [4, 5, 3]; \ ts_8 = [3, 5, 3]\]</span></p>
<p>They both have the pattern of [low, high, low]. In other words, the filter <span class="math inline">\(c=[1, 5, 1]\)</span> creates a spike in <span class="math inline">\(tsv\)</span> when the pattern in <span class="math inline">\(ts\)</span> is [low, high, low].</p>
<p>In a Euclidean space, the dot product of two vectors can be expressed as</p>
<p><span class="math display">\[a \cdot b = ||a|| \times ||b|| \times \cos{\theta_{ab}}\]</span></p>
<p>where <span class="math inline">\(||a||\)</span> and <span class="math inline">\(||b||\)</span> are the magnitude of the two products and <span class="math inline">\(\theta_{ab}\)</span> is the angle between <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span>. Since <span class="math inline">\(\cos{(0)}=1\)</span>, <span class="math inline">\(\cos{(\pi/2)} = 0\)</span>, and <span class="math inline">\(\cos{(\pi)}=-1\)</span>, the dot product not only measures the magnitudes of the two vectors, but also their correlations. Take an extreme example: when the angle between them is <span class="math inline">\(\pi\)</span>, they are orthogonal and the dot product is equal to zero no matter the magnitude.</p>
<p>To summarize what we have discussed so far, we say that convolution is cross-correlation. When the segment of the data is highly correlates to the filter, it creates a spike in value and hence indicates a certain pattern.</p>
<p>Second, convolution reduces the number of parameters of the model. Let’s go back to the example above. Suppose you hypothesize that there is a 3-day pattern in the data, which actually prompted the use of a filter with size 3. If you want to look at all windows of size 3 in the data, you would be looking at 8 of such windows and a total of 24 parameters, 1 for each day in each window. By using convolution and the sliding filter, you only need 3 filters: the size of the filter. This is not much of a saving in our example, but imagine the case of images, and the difference is huge.</p>
<p>By using the filter sliding through the data, we have stopped to care where the pattern happens, but only that it has happened. This is called <code>translational invariance</code>, which is important, again, in computer vision. Imagine you have two pictures of the same cat in the same posture from the same angle, except one of them the cat is on the floor and the other up on the table. It is the same cat. Your filter should be finding the cat, and it should not care where the cat is.</p>
<p>Translational invariance is not as prominent in time-series data, but here is one example with our stock price data: suppose every time a stock’s price goes up by more than 10% in a single day, it will follow with a decline; but if the hike is less than 5%, it will follow with another hike. This is a pattern that a filter (or two) should be able to match. And it does not matter when (in analagous to where in CV) it happens.</p>
<p>Third, and before we move on to code, we should introduce two related concepts in CNN: pooling and feature maps. Pooling reduces the size of the data. Continue with our example above with <span class="math inline">\(ts\)</span> and <span class="math inline">\(c\)</span>. Suppose we do a <code>full</code> mode convolution, i.e., sliding <span class="math inline">\(c\)</span> over <span class="math inline">\(tsz\)</span>, then we have the new convolved series as:</p>
<p><span class="math display">\[tsf = [9, 26, 32, 23, 22, 25, 17, 22, 31, 20]\]</span></p>
<p>we can perform <code>max</code> pooling on <span class="math inline">\(tsf\)</span> to reduce its size to 5. What we do is to group every two numbers, then pick the highest number from the group:</p>
<p><span class="math inline">\(tsfp = [\{9, 26\}, \{32, 23\}, \{22, 25\}, \{17, 22\}, \{31, 20\}]\)</span></p>
<p><span class="math inline">\(tsfp = [26, 32, 25, 22, 31]\)</span></p>
<p>The other way to do pooling is <code>average</code> pooling, but max pooling is more intuitive. At a high level, pooling, especially max pooling, does two things: it reduces the size of the data but preserves the “spikes”. In other words, this is another operation of “we do not care where/when as long as it happens”.</p>
<p>By convention, even though pooling has reduced the size of the data, filter size remains the same. In other words, if we overlay <span class="math inline">\(c\)</span> on <span class="math inline">\(tsfp\)</span>, at the first location (<span class="math inline">\(tsfp_1 = [26, 32, 25]\)</span>), <span class="math inline">\(c\)</span> is now finding patterns from the first 7 numbers in <span class="math inline">\(ts\)</span>. To see this, note that the value 25 in <span class="math inline">\(tsfp_1\)</span> was calculated by</p>
<p><span class="math display">\[[1, 5, 1] \cdot ts_5 \Rightarrow [1, 5, 1] \cdot [3, 4, 5]\]</span></p>
<p>where the value 5 in <span class="math inline">\(ts_5\)</span> is the 7th value of <span class="math inline">\(ts\)</span>. In other words, with pooling and same size filters, CNN is able to see bigger and bigger “pictures” when data is passed through the convolution layers.</p>
<p>However, it is important to increase the number of filters after each pooling until the size of the feature map is large enough. A <code>feature map</code> is a collection of features. It has a pictorial name because CNN was first developed for computer vision. The reason for the increasing size of feature map is straightforward: as data goes through the convolution layers, the filters are search wider and wider due to pooling. Increasing the number of features/filters would allow the CNN to look deeper. This helps to preserve information while transformation is happening. For time-series data, instead of a long time series, we can think of the data output from the convolution layers as a stack of many moments.</p>
<p>After going through the convolution (and pooling) layers, the output is fed into some <code>Dense</code> layers just like ANN. In a way, we can think of CNN as two-stage feature engineering: convolution layers and Dense layers.</p>
</div>
<div id="deep-learning-algorithms-in-tensorflowkeras" class="section level2 hasAnchor" number="3.6">
<h2><span class="header-section-number">3.6</span> Deep Learning Algorithms in TensorFlow/Keras<a href="time-series-forecasting-and-deep-learning-algorithms.html#deep-learning-algorithms-in-tensorflowkeras" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The implementation of ANN, RNN, and CNN are similar when using TensorFlow/Keras. The main difference is in how the hidden layers are constructed, with the minor caveat that the dimensions of input and output data from different models (notably ANN) can be different. As a result, it is important pay attention to the shapes of the arrays or dataframes that we feed or receive. In the following script, you will see places where it performs such checks. Otherwise, the three functions in the beginning of the script are the only differences in how these models are constructed in Keras:</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb48-2"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-2" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb48-3"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb48-4"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-4" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb48-5"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-5" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb48-6"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-6" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb48-7"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-7" tabindex="-1"></a></span>
<span id="cb48-8"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-8" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb48-9"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-9" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Dense, Input  <span class="co"># ANN</span></span>
<span id="cb48-10"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-10" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> LSTM, GRU, SimpleRNN  <span class="co"># RNN</span></span>
<span id="cb48-11"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-11" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Conv1D, MaxPooling1D, GlobalMaxPooling1D  <span class="co"># CNN</span></span>
<span id="cb48-12"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-12" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Model</span>
<span id="cb48-13"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-13" tabindex="-1"></a></span>
<span id="cb48-14"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-14" tabindex="-1"></a></span>
<span id="cb48-15"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-15" tabindex="-1"></a><span class="kw">def</span> ann(T, num_units<span class="op">=</span><span class="dv">32</span>):</span>
<span id="cb48-16"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-16" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb48-17"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-17" tabindex="-1"></a><span class="co">    Create a basic Artificial Neural Network (ANN) model.</span></span>
<span id="cb48-18"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-18" tabindex="-1"></a></span>
<span id="cb48-19"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-19" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb48-20"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-20" tabindex="-1"></a><span class="co">        T (int): Time steps or input size.</span></span>
<span id="cb48-21"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-21" tabindex="-1"></a><span class="co">        num_layers (int): Number of layers in the ANN.</span></span>
<span id="cb48-22"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-22" tabindex="-1"></a></span>
<span id="cb48-23"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-23" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb48-24"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-24" tabindex="-1"></a><span class="co">        tuple: Input and output tensors of the ANN model.</span></span>
<span id="cb48-25"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-25" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb48-26"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-26" tabindex="-1"></a>    i <span class="op">=</span> Input(shape<span class="op">=</span>(T,))</span>
<span id="cb48-27"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-27" tabindex="-1"></a>    x <span class="op">=</span> Dense(num_units, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>)(i)</span>
<span id="cb48-28"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-28" tabindex="-1"></a>    x <span class="op">=</span> Dense(num_units, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>)(x)</span>
<span id="cb48-29"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-29" tabindex="-1"></a></span>
<span id="cb48-30"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-30" tabindex="-1"></a>    <span class="cf">return</span> i, x</span>
<span id="cb48-31"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-31" tabindex="-1"></a></span>
<span id="cb48-32"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-32" tabindex="-1"></a></span>
<span id="cb48-33"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-33" tabindex="-1"></a><span class="kw">def</span> rnn(T, D, num_units<span class="op">=</span><span class="dv">32</span>, rnn_model<span class="op">=</span><span class="st">&quot;lstm&quot;</span>):</span>
<span id="cb48-34"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-34" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb48-35"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-35" tabindex="-1"></a><span class="co">    Create a Recurrent Neural Network (RNN) model.</span></span>
<span id="cb48-36"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-36" tabindex="-1"></a></span>
<span id="cb48-37"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-37" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb48-38"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-38" tabindex="-1"></a><span class="co">        T (int): Time steps or input size.</span></span>
<span id="cb48-39"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-39" tabindex="-1"></a><span class="co">        D (int): Dimensionality of the input.</span></span>
<span id="cb48-40"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-40" tabindex="-1"></a><span class="co">        num_layers (int): Number of layers in the RNN.</span></span>
<span id="cb48-41"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-41" tabindex="-1"></a><span class="co">        rnn_model (str): RNN model type (&#39;lstm&#39;, &#39;gru&#39;, or &#39;simple_rnn&#39;).</span></span>
<span id="cb48-42"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-42" tabindex="-1"></a></span>
<span id="cb48-43"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-43" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb48-44"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-44" tabindex="-1"></a><span class="co">        tuple: Input and output tensors of the RNN model.</span></span>
<span id="cb48-45"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-45" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb48-46"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-46" tabindex="-1"></a>    i <span class="op">=</span> Input(shape<span class="op">=</span>(T, D))</span>
<span id="cb48-47"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-47" tabindex="-1"></a>    <span class="cf">if</span> rnn_model <span class="op">==</span> <span class="st">&#39;lstm&#39;</span>:</span>
<span id="cb48-48"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-48" tabindex="-1"></a>        x <span class="op">=</span> LSTM(num_units, return_sequences<span class="op">=</span><span class="va">True</span>)(i)</span>
<span id="cb48-49"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-49" tabindex="-1"></a>        x <span class="op">=</span> LSTM(num_units)(x)</span>
<span id="cb48-50"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-50" tabindex="-1"></a>    <span class="cf">elif</span> rnn_model <span class="op">==</span> <span class="st">&#39;gru&#39;</span>:</span>
<span id="cb48-51"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-51" tabindex="-1"></a>        x <span class="op">=</span> GRU(num_units, return_sequences<span class="op">=</span><span class="va">True</span>)(i)</span>
<span id="cb48-52"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-52" tabindex="-1"></a>        x <span class="op">=</span> GRU(num_units)(x)</span>
<span id="cb48-53"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-53" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb48-54"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-54" tabindex="-1"></a>        x <span class="op">=</span> SimpleRNN(num_units, return_sequences<span class="op">=</span><span class="va">True</span>)(i)</span>
<span id="cb48-55"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-55" tabindex="-1"></a>        x <span class="op">=</span> SimpleRNN(num_units)(x)</span>
<span id="cb48-56"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-56" tabindex="-1"></a></span>
<span id="cb48-57"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-57" tabindex="-1"></a>    <span class="cf">return</span> i, x</span>
<span id="cb48-58"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-58" tabindex="-1"></a></span>
<span id="cb48-59"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-59" tabindex="-1"></a></span>
<span id="cb48-60"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-60" tabindex="-1"></a><span class="kw">def</span> cnn(T, D):</span>
<span id="cb48-61"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-61" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb48-62"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-62" tabindex="-1"></a><span class="co">    Create a Convolutional Neural Network (CNN) model.</span></span>
<span id="cb48-63"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-63" tabindex="-1"></a></span>
<span id="cb48-64"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-64" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb48-65"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-65" tabindex="-1"></a><span class="co">        T (int): Time steps or input size.</span></span>
<span id="cb48-66"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-66" tabindex="-1"></a><span class="co">        D (int): Dimensionality of the input.</span></span>
<span id="cb48-67"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-67" tabindex="-1"></a></span>
<span id="cb48-68"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-68" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb48-69"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-69" tabindex="-1"></a><span class="co">        tuple: Input and output tensors of the CNN model.</span></span>
<span id="cb48-70"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-70" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb48-71"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-71" tabindex="-1"></a>    i <span class="op">=</span> Input(shape<span class="op">=</span>(T, D))</span>
<span id="cb48-72"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-72" tabindex="-1"></a>    x <span class="op">=</span> Conv1D(<span class="dv">16</span>, <span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>, padding<span class="op">=</span><span class="st">&#39;same&#39;</span>)(i)</span>
<span id="cb48-73"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-73" tabindex="-1"></a>    x <span class="op">=</span> MaxPooling1D(<span class="dv">2</span>)(x)</span>
<span id="cb48-74"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-74" tabindex="-1"></a>    x <span class="op">=</span> Conv1D(<span class="dv">32</span>, <span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>, padding<span class="op">=</span><span class="st">&#39;same&#39;</span>)(x)</span>
<span id="cb48-75"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-75" tabindex="-1"></a>    x <span class="op">=</span> GlobalMaxPooling1D()(x)</span>
<span id="cb48-76"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-76" tabindex="-1"></a></span>
<span id="cb48-77"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-77" tabindex="-1"></a>    <span class="cf">return</span> i, x</span>
<span id="cb48-78"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-78" tabindex="-1"></a></span>
<span id="cb48-79"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-79" tabindex="-1"></a></span>
<span id="cb48-80"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-80" tabindex="-1"></a><span class="kw">class</span> StocksForecastDL:</span>
<span id="cb48-81"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-81" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb48-82"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-82" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb48-83"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-83" tabindex="-1"></a>        stock_name_list<span class="op">=</span>(<span class="st">&#39;UAL&#39;</span>, <span class="st">&#39;WMT&#39;</span>, <span class="st">&#39;PFE&#39;</span>),</span>
<span id="cb48-84"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-84" tabindex="-1"></a>        start_date<span class="op">=</span><span class="st">&#39;2018-01-01&#39;</span>,</span>
<span id="cb48-85"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-85" tabindex="-1"></a>        end_date<span class="op">=</span><span class="st">&#39;2022-12-31&#39;</span>,</span>
<span id="cb48-86"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-86" tabindex="-1"></a>        t<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb48-87"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-87" tabindex="-1"></a>        n_test<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb48-88"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-88" tabindex="-1"></a>        epochs<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb48-89"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-89" tabindex="-1"></a>    ):</span>
<span id="cb48-90"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-90" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb48-91"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-91" tabindex="-1"></a><span class="co">        Initialize the StocksForecastDL class.</span></span>
<span id="cb48-92"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-92" tabindex="-1"></a></span>
<span id="cb48-93"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-93" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb48-94"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-94" tabindex="-1"></a><span class="co">            stock_name_list (tuple): List of stock names.</span></span>
<span id="cb48-95"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-95" tabindex="-1"></a><span class="co">            start_date (str): Start date for data retrieval.</span></span>
<span id="cb48-96"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-96" tabindex="-1"></a><span class="co">            end_date (str): End date for data retrieval.</span></span>
<span id="cb48-97"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-97" tabindex="-1"></a><span class="co">            t (int): Number of time steps.</span></span>
<span id="cb48-98"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-98" tabindex="-1"></a><span class="co">            n_test (int): length of forecast horizon.</span></span>
<span id="cb48-99"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-99" tabindex="-1"></a><span class="co">            epochs (int): Number of training epochs.</span></span>
<span id="cb48-100"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-100" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb48-101"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-101" tabindex="-1"></a>        <span class="va">self</span>.T <span class="op">=</span> t</span>
<span id="cb48-102"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-102" tabindex="-1"></a>        <span class="va">self</span>.N_TEST <span class="op">=</span> n_test</span>
<span id="cb48-103"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-103" tabindex="-1"></a>        <span class="va">self</span>.EPOCHS <span class="op">=</span> epochs</span>
<span id="cb48-104"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-104" tabindex="-1"></a>        <span class="va">self</span>.dfs <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb48-105"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-105" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> stock_name_list:</span>
<span id="cb48-106"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-106" tabindex="-1"></a>            <span class="va">self</span>.dfs[name] <span class="op">=</span> yf.download(name, start<span class="op">=</span>start_date, end<span class="op">=</span>end_date)</span>
<span id="cb48-107"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-107" tabindex="-1"></a>            <span class="va">self</span>.dfs[name][<span class="st">&#39;Diff&#39;</span>] <span class="op">=</span> <span class="va">self</span>.dfs[name][<span class="st">&#39;Close&#39;</span>].diff(<span class="dv">1</span>)</span>
<span id="cb48-108"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-108" tabindex="-1"></a>            <span class="va">self</span>.dfs[name][<span class="st">&#39;Log&#39;</span>] <span class="op">=</span> np.log(<span class="va">self</span>.dfs[name][<span class="st">&#39;Close&#39;</span>])</span>
<span id="cb48-109"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-109" tabindex="-1"></a></span>
<span id="cb48-110"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-110" tabindex="-1"></a>        <span class="va">self</span>.train_idx <span class="op">=</span> []</span>
<span id="cb48-111"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-111" tabindex="-1"></a>        <span class="va">self</span>.test_idx <span class="op">=</span> []</span>
<span id="cb48-112"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-112" tabindex="-1"></a></span>
<span id="cb48-113"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-113" tabindex="-1"></a>    <span class="kw">def</span> prepare_data(<span class="va">self</span>, df, col, ann<span class="op">=</span><span class="va">False</span>, multioutput<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb48-114"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-114" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb48-115"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-115" tabindex="-1"></a><span class="co">        Prepare the data for training and testing.</span></span>
<span id="cb48-116"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-116" tabindex="-1"></a></span>
<span id="cb48-117"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-117" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb48-118"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-118" tabindex="-1"></a><span class="co">            df (DataFrame): Input data.</span></span>
<span id="cb48-119"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-119" tabindex="-1"></a><span class="co">            col (list): List of columns to be used.</span></span>
<span id="cb48-120"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-120" tabindex="-1"></a><span class="co">            ann (bool): Indicates whether ANN model is used.</span></span>
<span id="cb48-121"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-121" tabindex="-1"></a><span class="co">            multioutput (bool): Indicates whether multioutput prediction is performed.</span></span>
<span id="cb48-122"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-122" tabindex="-1"></a></span>
<span id="cb48-123"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-123" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb48-124"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-124" tabindex="-1"></a><span class="co">            tuple: Prepared data for training and testing.</span></span>
<span id="cb48-125"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-125" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb48-126"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-126" tabindex="-1"></a>        train <span class="op">=</span> df.iloc[:<span class="op">-</span><span class="va">self</span>.N_TEST]</span>
<span id="cb48-127"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-127" tabindex="-1"></a>        test <span class="op">=</span> df.iloc[<span class="op">-</span><span class="va">self</span>.N_TEST:]</span>
<span id="cb48-128"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-128" tabindex="-1"></a>        train_idx <span class="op">=</span> df.index <span class="op">&lt;=</span> train.index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb48-129"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-129" tabindex="-1"></a>        test_idx <span class="op">=</span> df.index <span class="op">&gt;</span> train.index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb48-130"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-130" tabindex="-1"></a></span>
<span id="cb48-131"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-131" tabindex="-1"></a>        series <span class="op">=</span> df[col].dropna().to_numpy()</span>
<span id="cb48-132"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-132" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb48-133"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-133" tabindex="-1"></a>            d <span class="op">=</span> series.shape[<span class="dv">1</span>]</span>
<span id="cb48-134"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-134" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">AttributeError</span>:</span>
<span id="cb48-135"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-135" tabindex="-1"></a>            d <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb48-136"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-136" tabindex="-1"></a></span>
<span id="cb48-137"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-137" tabindex="-1"></a>        X <span class="op">=</span> []</span>
<span id="cb48-138"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-138" tabindex="-1"></a>        Y <span class="op">=</span> []</span>
<span id="cb48-139"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-139" tabindex="-1"></a></span>
<span id="cb48-140"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-140" tabindex="-1"></a>        start_idx <span class="op">=</span> <span class="va">self</span>.N_TEST</span>
<span id="cb48-141"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-141" tabindex="-1"></a>        <span class="cf">if</span> multioutput:</span>
<span id="cb48-142"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-142" tabindex="-1"></a>            <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(series) <span class="op">-</span> <span class="va">self</span>.T <span class="op">-</span> <span class="va">self</span>.N_TEST <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb48-143"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-143" tabindex="-1"></a>                x <span class="op">=</span> series[t:t <span class="op">+</span> <span class="va">self</span>.T]</span>
<span id="cb48-144"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-144" tabindex="-1"></a>                X.append(x)</span>
<span id="cb48-145"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-145" tabindex="-1"></a>                y <span class="op">=</span> series[t <span class="op">+</span> <span class="va">self</span>.T:t <span class="op">+</span> <span class="va">self</span>.T <span class="op">+</span> <span class="va">self</span>.N_TEST]</span>
<span id="cb48-146"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-146" tabindex="-1"></a>                Y.append(y)</span>
<span id="cb48-147"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-147" tabindex="-1"></a></span>
<span id="cb48-148"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-148" tabindex="-1"></a>            Y <span class="op">=</span> np.array(Y).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="va">self</span>.N_TEST)</span>
<span id="cb48-149"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-149" tabindex="-1"></a>            start_idx <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb48-150"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-150" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb48-151"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-151" tabindex="-1"></a>            <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(series) <span class="op">-</span> <span class="va">self</span>.T):</span>
<span id="cb48-152"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-152" tabindex="-1"></a>                x <span class="op">=</span> series[t:t <span class="op">+</span> <span class="va">self</span>.T]</span>
<span id="cb48-153"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-153" tabindex="-1"></a>                X.append(x)</span>
<span id="cb48-154"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-154" tabindex="-1"></a>                y <span class="op">=</span> series[t <span class="op">+</span> <span class="va">self</span>.T]</span>
<span id="cb48-155"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-155" tabindex="-1"></a>                Y.append(y)</span>
<span id="cb48-156"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-156" tabindex="-1"></a></span>
<span id="cb48-157"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-157" tabindex="-1"></a>            Y <span class="op">=</span> np.array(Y)</span>
<span id="cb48-158"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-158" tabindex="-1"></a></span>
<span id="cb48-159"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-159" tabindex="-1"></a>        <span class="cf">if</span> ann <span class="kw">and</span> d <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb48-160"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-160" tabindex="-1"></a>            X <span class="op">=</span> np.array(X).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="va">self</span>.T)</span>
<span id="cb48-161"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-161" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb48-162"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-162" tabindex="-1"></a>            X <span class="op">=</span> np.array(X).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="va">self</span>.T, d)</span>
<span id="cb48-163"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-163" tabindex="-1"></a></span>
<span id="cb48-164"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-164" tabindex="-1"></a>        N <span class="op">=</span> <span class="bu">len</span>(X)</span>
<span id="cb48-165"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-165" tabindex="-1"></a></span>
<span id="cb48-166"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-166" tabindex="-1"></a>        Xtrain, Ytrain <span class="op">=</span> X[:<span class="op">-</span>start_idx], Y[:<span class="op">-</span>start_idx]</span>
<span id="cb48-167"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-167" tabindex="-1"></a>        Xtest, Ytest <span class="op">=</span> X[<span class="op">-</span>start_idx:], Y[<span class="op">-</span>start_idx:]</span>
<span id="cb48-168"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-168" tabindex="-1"></a></span>
<span id="cb48-169"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-169" tabindex="-1"></a>        <span class="cf">return</span> Xtrain, Ytrain, Xtest, Ytest, train_idx, test_idx, N, d</span>
<span id="cb48-170"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-170" tabindex="-1"></a></span>
<span id="cb48-171"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-171" tabindex="-1"></a>    <span class="kw">def</span> make_predictions(<span class="va">self</span>,</span>
<span id="cb48-172"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-172" tabindex="-1"></a>                         stock_name,</span>
<span id="cb48-173"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-173" tabindex="-1"></a>                         orig_col,</span>
<span id="cb48-174"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-174" tabindex="-1"></a>                         train_idx,</span>
<span id="cb48-175"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-175" tabindex="-1"></a>                         test_idx,</span>
<span id="cb48-176"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-176" tabindex="-1"></a>                         Xtrain,</span>
<span id="cb48-177"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-177" tabindex="-1"></a>                         Xtest,</span>
<span id="cb48-178"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-178" tabindex="-1"></a>                         model,</span>
<span id="cb48-179"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-179" tabindex="-1"></a>                         ann<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb48-180"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-180" tabindex="-1"></a>                         multioutput<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb48-181"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-181" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb48-182"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-182" tabindex="-1"></a><span class="co">        Make predictions using the trained model.</span></span>
<span id="cb48-183"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-183" tabindex="-1"></a></span>
<span id="cb48-184"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-184" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb48-185"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-185" tabindex="-1"></a><span class="co">            stock_name (str): Name of the stock.</span></span>
<span id="cb48-186"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-186" tabindex="-1"></a><span class="co">            orig_col (list): Original columns used for predictions.</span></span>
<span id="cb48-187"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-187" tabindex="-1"></a><span class="co">            train_idx (bool): Index of training samples.</span></span>
<span id="cb48-188"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-188" tabindex="-1"></a><span class="co">            test_idx (bool): Index of test samples.</span></span>
<span id="cb48-189"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-189" tabindex="-1"></a><span class="co">            Xtrain (ndarray): Training input data.</span></span>
<span id="cb48-190"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-190" tabindex="-1"></a><span class="co">            Xtest (ndarray): Test input data.</span></span>
<span id="cb48-191"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-191" tabindex="-1"></a><span class="co">            model (Model): Trained model.</span></span>
<span id="cb48-192"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-192" tabindex="-1"></a><span class="co">            ann (bool): Indicates whether ANN model is used.</span></span>
<span id="cb48-193"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-193" tabindex="-1"></a><span class="co">            multioutput (bool): Indicates whether multioutput prediction is performed.</span></span>
<span id="cb48-194"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-194" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb48-195"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-195" tabindex="-1"></a>        train <span class="op">=</span> <span class="va">self</span>.dfs[stock_name].iloc[:<span class="op">-</span><span class="va">self</span>.N_TEST]</span>
<span id="cb48-196"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-196" tabindex="-1"></a>        train_idx[:<span class="va">self</span>.T <span class="op">+</span> <span class="dv">1</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb48-197"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-197" tabindex="-1"></a></span>
<span id="cb48-198"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-198" tabindex="-1"></a>        <span class="cf">if</span> multioutput:</span>
<span id="cb48-199"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-199" tabindex="-1"></a>            Ptrain <span class="op">=</span> model.predict(Xtrain)[:, <span class="dv">0</span>]</span>
<span id="cb48-200"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-200" tabindex="-1"></a>            Ptest <span class="op">=</span> model.predict(Xtest)[<span class="dv">0</span>]</span>
<span id="cb48-201"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-201" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb48-202"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-202" tabindex="-1"></a>            Ptrain <span class="op">=</span> model.predict(Xtrain).flatten()</span>
<span id="cb48-203"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-203" tabindex="-1"></a>            Ptest <span class="op">=</span> model.predict(Xtest).flatten()</span>
<span id="cb48-204"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-204" tabindex="-1"></a></span>
<span id="cb48-205"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-205" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> orig_col:</span>
<span id="cb48-206"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-206" tabindex="-1"></a>            <span class="va">self</span>.dfs[stock_name][<span class="ss">f&#39;Shift</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">&#39;</span>] <span class="op">=</span> <span class="va">self</span>.dfs[stock_name][c].shift(<span class="dv">1</span>)</span>
<span id="cb48-207"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-207" tabindex="-1"></a></span>
<span id="cb48-208"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-208" tabindex="-1"></a>        new_col <span class="op">=</span> [<span class="st">&quot;Shift&quot;</span> <span class="op">+</span> word <span class="cf">for</span> word <span class="kw">in</span> orig_col]</span>
<span id="cb48-209"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-209" tabindex="-1"></a>        prev <span class="op">=</span> <span class="va">self</span>.dfs[stock_name][new_col]</span>
<span id="cb48-210"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-210" tabindex="-1"></a></span>
<span id="cb48-211"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-211" tabindex="-1"></a>        last_train <span class="op">=</span> train.iloc[<span class="op">-</span><span class="dv">1</span>][orig_col]</span>
<span id="cb48-212"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-212" tabindex="-1"></a></span>
<span id="cb48-213"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-213" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> multioutput:</span>
<span id="cb48-214"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-214" tabindex="-1"></a>            <span class="va">self</span>.dfs[stock_name].loc[train_idx, <span class="st">&#39;1step_train&#39;</span>] <span class="op">=</span> prev[train_idx].squeeze() <span class="op">+</span> Ptrain</span>
<span id="cb48-215"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-215" tabindex="-1"></a>            <span class="va">self</span>.dfs[stock_name].loc[test_idx, <span class="st">&#39;1step_test&#39;</span>] <span class="op">=</span> prev[test_idx].squeeze() <span class="op">+</span> Ptest</span>
<span id="cb48-216"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-216" tabindex="-1"></a></span>
<span id="cb48-217"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-217" tabindex="-1"></a>            multistep_predictions <span class="op">=</span> []</span>
<span id="cb48-218"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-218" tabindex="-1"></a>            last_x <span class="op">=</span> Xtest[<span class="dv">0</span>]</span>
<span id="cb48-219"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-219" tabindex="-1"></a></span>
<span id="cb48-220"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-220" tabindex="-1"></a>            <span class="cf">while</span> <span class="bu">len</span>(multistep_predictions) <span class="op">&lt;</span> <span class="va">self</span>.N_TEST:</span>
<span id="cb48-221"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-221" tabindex="-1"></a>                <span class="cf">if</span> ann:</span>
<span id="cb48-222"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-222" tabindex="-1"></a>                    p <span class="op">=</span> model.predict(last_x.reshape(<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>))[<span class="dv">0</span>]</span>
<span id="cb48-223"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-223" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb48-224"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-224" tabindex="-1"></a>                    p <span class="op">=</span> model.predict(last_x.reshape(<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))[<span class="dv">0</span>]</span>
<span id="cb48-225"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-225" tabindex="-1"></a></span>
<span id="cb48-226"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-226" tabindex="-1"></a>                multistep_predictions.append(p)</span>
<span id="cb48-227"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-227" tabindex="-1"></a>                last_x <span class="op">=</span> np.roll(last_x, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb48-228"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-228" tabindex="-1"></a>                last_x[<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> p[<span class="dv">0</span>]</span>
<span id="cb48-229"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-229" tabindex="-1"></a></span>
<span id="cb48-230"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-230" tabindex="-1"></a>            <span class="va">self</span>.dfs[stock_name].loc[test_idx, <span class="st">&#39;multistep&#39;</span>] <span class="op">=</span> last_train[<span class="dv">0</span>] <span class="op">+</span> np.cumsum(multistep_predictions)</span>
<span id="cb48-231"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-231" tabindex="-1"></a></span>
<span id="cb48-232"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-232" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb48-233"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-233" tabindex="-1"></a>            <span class="va">self</span>.dfs[stock_name].loc[test_idx, <span class="st">&#39;multioutput&#39;</span>] <span class="op">=</span> last_train[<span class="dv">0</span>] <span class="op">+</span> np.cumsum(Ptest)</span>
<span id="cb48-234"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-234" tabindex="-1"></a></span>
<span id="cb48-235"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-235" tabindex="-1"></a>    <span class="kw">def</span> run_forecast(<span class="va">self</span>,</span>
<span id="cb48-236"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-236" tabindex="-1"></a>                     stock_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">&#39;UAL&#39;</span>,</span>
<span id="cb48-237"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-237" tabindex="-1"></a>                     col: <span class="bu">list</span> <span class="op">=</span> [<span class="st">&#39;Log&#39;</span>],</span>
<span id="cb48-238"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-238" tabindex="-1"></a>                     diff<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb48-239"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-239" tabindex="-1"></a>                     model<span class="op">=</span><span class="st">&quot;cnn&quot;</span>,</span>
<span id="cb48-240"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-240" tabindex="-1"></a>                     multioutput<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb48-241"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-241" tabindex="-1"></a>                     plot<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb48-242"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-242" tabindex="-1"></a>                     <span class="op">**</span>kwargs):</span>
<span id="cb48-243"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-243" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb48-244"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-244" tabindex="-1"></a><span class="co">        Run the forecast for a given stock.</span></span>
<span id="cb48-245"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-245" tabindex="-1"></a></span>
<span id="cb48-246"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-246" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb48-247"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-247" tabindex="-1"></a><span class="co">            stock_name (str): Name of the stock.</span></span>
<span id="cb48-248"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-248" tabindex="-1"></a><span class="co">            col (list): List of columns to be used.</span></span>
<span id="cb48-249"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-249" tabindex="-1"></a><span class="co">            diff (bool): Indicates whether differencing is applied.</span></span>
<span id="cb48-250"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-250" tabindex="-1"></a><span class="co">            model (str): Model type (&#39;ann&#39;, &#39;rnn&#39;, or &#39;cnn&#39;).</span></span>
<span id="cb48-251"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-251" tabindex="-1"></a><span class="co">            multioutput (bool): Indicates whether multioutput prediction is performed.</span></span>
<span id="cb48-252"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-252" tabindex="-1"></a><span class="co">            plot (bool): Whether to plot. Default is True.</span></span>
<span id="cb48-253"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-253" tabindex="-1"></a><span class="co">            **kwargs: Additional keyword arguments for the selected model.</span></span>
<span id="cb48-254"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-254" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb48-255"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-255" tabindex="-1"></a></span>
<span id="cb48-256"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-256" tabindex="-1"></a>        D <span class="op">=</span> <span class="bu">len</span>(col)</span>
<span id="cb48-257"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-257" tabindex="-1"></a>        <span class="cf">if</span> D <span class="op">&gt;</span> <span class="dv">1</span> <span class="kw">and</span> model <span class="op">==</span> <span class="st">&quot;ann&quot;</span>:</span>
<span id="cb48-258"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-258" tabindex="-1"></a>            warnings.warn(<span class="st">&quot;Currently, ANN only runs with a single variable.&quot;</span>)</span>
<span id="cb48-259"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-259" tabindex="-1"></a>            sys.exit(<span class="dv">1</span>)</span>
<span id="cb48-260"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-260" tabindex="-1"></a></span>
<span id="cb48-261"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-261" tabindex="-1"></a>        new_col <span class="op">=</span> col.copy()</span>
<span id="cb48-262"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-262" tabindex="-1"></a>        <span class="cf">if</span> diff:</span>
<span id="cb48-263"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-263" tabindex="-1"></a>            <span class="cf">for</span> c <span class="kw">in</span> col:</span>
<span id="cb48-264"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-264" tabindex="-1"></a>                <span class="va">self</span>.dfs[stock_name][<span class="ss">f&#39;Diff</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">&#39;</span>] <span class="op">=</span> <span class="va">self</span>.dfs[stock_name][c].diff()</span>
<span id="cb48-265"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-265" tabindex="-1"></a>            new_col <span class="op">=</span> [<span class="st">&quot;Diff&quot;</span> <span class="op">+</span> word <span class="cf">for</span> word <span class="kw">in</span> new_col]</span>
<span id="cb48-266"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-266" tabindex="-1"></a></span>
<span id="cb48-267"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-267" tabindex="-1"></a>        <span class="cf">if</span> model <span class="op">==</span> <span class="st">&#39;ann&#39;</span>:</span>
<span id="cb48-268"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-268" tabindex="-1"></a>            ann_bool <span class="op">=</span> <span class="va">True</span></span>
<span id="cb48-269"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-269" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb48-270"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-270" tabindex="-1"></a>            ann_bool <span class="op">=</span> <span class="va">False</span></span>
<span id="cb48-271"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-271" tabindex="-1"></a></span>
<span id="cb48-272"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-272" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.prepare_data(df<span class="op">=</span><span class="va">self</span>.dfs[stock_name], col<span class="op">=</span>new_col, ann<span class="op">=</span>ann_bool, multioutput<span class="op">=</span>multioutput)</span>
<span id="cb48-273"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-273" tabindex="-1"></a>        Xtrain, Ytrain, Xtest, Ytest, train_idx, test_idx, N, D <span class="op">=</span> output</span>
<span id="cb48-274"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-274" tabindex="-1"></a></span>
<span id="cb48-275"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-275" tabindex="-1"></a>        <span class="va">self</span>.train_idx <span class="op">=</span> train_idx</span>
<span id="cb48-276"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-276" tabindex="-1"></a>        <span class="va">self</span>.test_idx <span class="op">=</span> test_idx</span>
<span id="cb48-277"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-277" tabindex="-1"></a></span>
<span id="cb48-278"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-278" tabindex="-1"></a>        build_model <span class="op">=</span> <span class="bu">eval</span>(model)</span>
<span id="cb48-279"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-279" tabindex="-1"></a>        <span class="cf">if</span> model <span class="op">==</span> <span class="st">&#39;ann&#39;</span>:</span>
<span id="cb48-280"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-280" tabindex="-1"></a>            i, x <span class="op">=</span> build_model(T<span class="op">=</span><span class="va">self</span>.T, <span class="op">**</span>kwargs)</span>
<span id="cb48-281"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-281" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb48-282"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-282" tabindex="-1"></a>            i, x <span class="op">=</span> build_model(T<span class="op">=</span><span class="va">self</span>.T, D<span class="op">=</span>D, <span class="op">**</span>kwargs)</span>
<span id="cb48-283"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-283" tabindex="-1"></a></span>
<span id="cb48-284"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-284" tabindex="-1"></a>        <span class="cf">if</span> multioutput:</span>
<span id="cb48-285"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-285" tabindex="-1"></a>            x <span class="op">=</span> Dense(<span class="va">self</span>.N_TEST)(x)</span>
<span id="cb48-286"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-286" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb48-287"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-287" tabindex="-1"></a>            x <span class="op">=</span> Dense(<span class="dv">1</span>)(x)</span>
<span id="cb48-288"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-288" tabindex="-1"></a></span>
<span id="cb48-289"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-289" tabindex="-1"></a>        nn_model <span class="op">=</span> Model(i, x)</span>
<span id="cb48-290"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-290" tabindex="-1"></a></span>
<span id="cb48-291"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-291" tabindex="-1"></a>        nn_model.summary()</span>
<span id="cb48-292"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-292" tabindex="-1"></a></span>
<span id="cb48-293"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-293" tabindex="-1"></a>        nn_model.<span class="bu">compile</span>(</span>
<span id="cb48-294"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-294" tabindex="-1"></a>            loss<span class="op">=</span><span class="st">&#39;mse&#39;</span>,</span>
<span id="cb48-295"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-295" tabindex="-1"></a>            optimizer<span class="op">=</span><span class="st">&#39;adam&#39;</span>,</span>
<span id="cb48-296"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-296" tabindex="-1"></a>            metrics<span class="op">=</span><span class="st">&#39;mae&#39;</span>,</span>
<span id="cb48-297"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-297" tabindex="-1"></a>        )</span>
<span id="cb48-298"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-298" tabindex="-1"></a></span>
<span id="cb48-299"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-299" tabindex="-1"></a>        r <span class="op">=</span> nn_model.fit(</span>
<span id="cb48-300"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-300" tabindex="-1"></a>            Xtrain,</span>
<span id="cb48-301"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-301" tabindex="-1"></a>            Ytrain,</span>
<span id="cb48-302"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-302" tabindex="-1"></a>            epochs<span class="op">=</span><span class="va">self</span>.EPOCHS,</span>
<span id="cb48-303"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-303" tabindex="-1"></a>            validation_data<span class="op">=</span>(Xtest, Ytest),</span>
<span id="cb48-304"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-304" tabindex="-1"></a>            verbose<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb48-305"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-305" tabindex="-1"></a>        )</span>
<span id="cb48-306"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-306" tabindex="-1"></a></span>
<span id="cb48-307"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-307" tabindex="-1"></a>        <span class="cf">if</span> plot:</span>
<span id="cb48-308"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-308" tabindex="-1"></a>            plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb48-309"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-309" tabindex="-1"></a>            plt.plot(r.history[<span class="st">&#39;loss&#39;</span>], label<span class="op">=</span><span class="st">&#39;train loss&#39;</span>)</span>
<span id="cb48-310"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-310" tabindex="-1"></a>            plt.plot(r.history[<span class="st">&#39;val_loss&#39;</span>], label<span class="op">=</span><span class="st">&#39;test loss&#39;</span>)</span>
<span id="cb48-311"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-311" tabindex="-1"></a>            plt.legend()</span>
<span id="cb48-312"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-312" tabindex="-1"></a></span>
<span id="cb48-313"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-313" tabindex="-1"></a>            <span class="cf">if</span> multioutput:</span>
<span id="cb48-314"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-314" tabindex="-1"></a>                step_type <span class="op">=</span> <span class="st">&quot;multi&quot;</span></span>
<span id="cb48-315"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-315" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb48-316"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-316" tabindex="-1"></a>                step_type <span class="op">=</span> <span class="st">&quot;single&quot;</span></span>
<span id="cb48-317"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-317" tabindex="-1"></a>            <span class="cf">if</span> model <span class="op">==</span> <span class="st">&quot;rnn&quot;</span>:</span>
<span id="cb48-318"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-318" tabindex="-1"></a>                rnn_model <span class="op">=</span> kwargs.get(<span class="st">&quot;rnn_model&quot;</span>)</span>
<span id="cb48-319"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-319" tabindex="-1"></a>                plt.savefig(<span class="ss">f&quot;</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>rnn_model<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>step_type<span class="sc">}</span><span class="ss">_hist.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb48-320"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-320" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb48-321"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-321" tabindex="-1"></a>                plt.savefig(<span class="ss">f&quot;</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>step_type<span class="sc">}</span><span class="ss">_hist.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb48-322"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-322" tabindex="-1"></a>            plt.clf()</span>
<span id="cb48-323"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-323" tabindex="-1"></a></span>
<span id="cb48-324"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-324" tabindex="-1"></a>        <span class="va">self</span>.make_predictions(stock_name, col, train_idx, test_idx, Xtrain, Xtest, nn_model, ann_bool, multioutput)</span>
<span id="cb48-325"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-325" tabindex="-1"></a></span>
<span id="cb48-326"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-326" tabindex="-1"></a>    <span class="kw">def</span> single_model_comparison(<span class="va">self</span>,</span>
<span id="cb48-327"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-327" tabindex="-1"></a>                                stock_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">&#39;UAL&#39;</span>,</span>
<span id="cb48-328"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-328" tabindex="-1"></a>                                col: <span class="bu">list</span> <span class="op">=</span> [<span class="st">&#39;Log&#39;</span>],</span>
<span id="cb48-329"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-329" tabindex="-1"></a>                                diff<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb48-330"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-330" tabindex="-1"></a>                                model<span class="op">=</span><span class="st">&quot;cnn&quot;</span>,</span>
<span id="cb48-331"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-331" tabindex="-1"></a>                                plot<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb48-332"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-332" tabindex="-1"></a>                                <span class="op">**</span>kwargs):</span>
<span id="cb48-333"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-333" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb48-334"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-334" tabindex="-1"></a><span class="co">        Perform a comparison of a single model for a given stock.</span></span>
<span id="cb48-335"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-335" tabindex="-1"></a></span>
<span id="cb48-336"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-336" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb48-337"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-337" tabindex="-1"></a><span class="co">            stock_name (str): Name of the stock.</span></span>
<span id="cb48-338"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-338" tabindex="-1"></a><span class="co">            col (list): List of columns to be used.</span></span>
<span id="cb48-339"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-339" tabindex="-1"></a><span class="co">            diff (bool): Indicates whether differencing is applied.</span></span>
<span id="cb48-340"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-340" tabindex="-1"></a><span class="co">            model (str): Model type (&#39;ann&#39;, &#39;rnn&#39;, or &#39;cnn&#39;).</span></span>
<span id="cb48-341"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-341" tabindex="-1"></a><span class="co">            plot (bool): Whether to plot. Default is True.</span></span>
<span id="cb48-342"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-342" tabindex="-1"></a><span class="co">            **kwargs: Additional keyword arguments for the selected model.</span></span>
<span id="cb48-343"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-343" tabindex="-1"></a></span>
<span id="cb48-344"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-344" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb48-345"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-345" tabindex="-1"></a><span class="co">            DataFrame: DataFrame containing the predictions and evaluation metrics.</span></span>
<span id="cb48-346"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-346" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb48-347"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-347" tabindex="-1"></a></span>
<span id="cb48-348"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-348" tabindex="-1"></a>        <span class="va">self</span>.run_forecast(model<span class="op">=</span>model, stock_name<span class="op">=</span>stock_name, diff<span class="op">=</span>diff, plot<span class="op">=</span>plot, <span class="op">**</span>kwargs)</span>
<span id="cb48-349"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-349" tabindex="-1"></a>        <span class="va">self</span>.run_forecast(model<span class="op">=</span>model, stock_name<span class="op">=</span>stock_name, diff<span class="op">=</span>diff, multioutput<span class="op">=</span><span class="va">True</span>, plot<span class="op">=</span>plot, <span class="op">**</span>kwargs)</span>
<span id="cb48-350"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-350" tabindex="-1"></a></span>
<span id="cb48-351"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-351" tabindex="-1"></a>        <span class="cf">if</span> plot:</span>
<span id="cb48-352"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-352" tabindex="-1"></a>            pred_cols <span class="op">=</span> col <span class="op">+</span> [<span class="st">&#39;1step_test&#39;</span>, <span class="st">&#39;multistep&#39;</span>, <span class="st">&#39;multioutput&#39;</span>]</span>
<span id="cb48-353"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-353" tabindex="-1"></a>            <span class="va">self</span>.dfs[stock_name][pred_cols][<span class="op">-</span>(<span class="va">self</span>.N_TEST <span class="op">*</span> <span class="dv">3</span>):].plot(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb48-354"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-354" tabindex="-1"></a></span>
<span id="cb48-355"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-355" tabindex="-1"></a>            <span class="cf">if</span> model <span class="op">==</span> <span class="st">&quot;rnn&quot;</span>:</span>
<span id="cb48-356"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-356" tabindex="-1"></a>                rnn_model <span class="op">=</span> kwargs.get(<span class="st">&quot;rnn_model&quot;</span>)</span>
<span id="cb48-357"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-357" tabindex="-1"></a>                plt.savefig(<span class="ss">f&quot;</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>rnn_model<span class="sc">}</span><span class="ss">_comparison.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb48-358"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-358" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb48-359"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-359" tabindex="-1"></a>                plt.savefig(<span class="ss">f&quot;</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss">_comparison.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb48-360"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-360" tabindex="-1"></a>            plt.clf()</span>
<span id="cb48-361"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-361" tabindex="-1"></a></span>
<span id="cb48-362"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-362" tabindex="-1"></a></span>
<span id="cb48-363"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-363" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb48-364"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-364" tabindex="-1"></a>    <span class="co"># make sure to get reproducible results</span></span>
<span id="cb48-365"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-365" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb48-366"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-366" tabindex="-1"></a>    random.seed(<span class="dv">42</span>)</span>
<span id="cb48-367"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-367" tabindex="-1"></a>    tf.random.set_seed(<span class="dv">42</span>)</span>
<span id="cb48-368"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-368" tabindex="-1"></a></span>
<span id="cb48-369"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-369" tabindex="-1"></a>    plt.ion()</span>
<span id="cb48-370"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-370" tabindex="-1"></a></span>
<span id="cb48-371"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-371" tabindex="-1"></a>    ts <span class="op">=</span> StocksForecastDL(t<span class="op">=</span><span class="dv">20</span>, epochs<span class="op">=</span><span class="dv">1500</span>)</span>
<span id="cb48-372"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-372" tabindex="-1"></a></span>
<span id="cb48-373"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-373" tabindex="-1"></a>    ts.single_model_comparison(model<span class="op">=</span><span class="st">&quot;ann&quot;</span>, diff<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb48-374"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-374" tabindex="-1"></a>    ts.single_model_comparison(model<span class="op">=</span><span class="st">&quot;cnn&quot;</span>, diff<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb48-375"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb48-375" tabindex="-1"></a>    ts.single_model_comparison(model<span class="op">=</span><span class="st">&quot;rnn&quot;</span>, rnn_model<span class="op">=</span><span class="st">&quot;lstm&quot;</span>, diff<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</details>
<p>The class we create in this script is named <code>StocksForecastDL</code>, as we continue to the use stock prices as an example. Stock prices are not the best example to be used in forecasting, as they resemble “random walks”, but they are important in financial engineering and other related topics. As already mentioned, in the beginning of the script are three functions that provide the different constructs of the three models. For ANN, there are only <code>Dense</code> layers. In our example, we use two hidden layers each with 32 hidden units by default. For RNN, we need to specify which one of the three models we would like to implement and replace the <code>Dense</code> layers in the ANN by the relevant RNN layers. In each case, we implement two RNN layers with 32 hidden units, which is why <code>return_sequences</code> is set to <code>True</code> in the first RNN layer. For CNN, we replace <code>Dense</code> with <code>Conv1D</code> since we have a time-series data. If you are using CNN on images, you would likely be using <code>Conv2D</code>. The “Conv” layer should be followed by a Pooling layer. In this case, we use <code>GlobalMaxPooling1D</code>. As was discussed in the theory section, the size of feature map should increased from one lay to another. In our example, the first CNN layer has 16 features whereas that of the second layer is increased to 32:</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-1" tabindex="-1"></a><span class="kw">def</span> ann(T, num_units<span class="op">=</span><span class="dv">32</span>):</span>
<span id="cb49-2"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-2" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb49-3"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-3" tabindex="-1"></a><span class="co">    Create a basic Artificial Neural Network (ANN) model.</span></span>
<span id="cb49-4"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-4" tabindex="-1"></a></span>
<span id="cb49-5"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-5" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb49-6"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-6" tabindex="-1"></a><span class="co">        T (int): Time steps or input size.</span></span>
<span id="cb49-7"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-7" tabindex="-1"></a><span class="co">        num_layers (int): Number of layers in the ANN.</span></span>
<span id="cb49-8"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-8" tabindex="-1"></a></span>
<span id="cb49-9"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-9" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb49-10"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-10" tabindex="-1"></a><span class="co">        tuple: Input and output tensors of the ANN model.</span></span>
<span id="cb49-11"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-11" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb49-12"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-12" tabindex="-1"></a>    i <span class="op">=</span> Input(shape<span class="op">=</span>(T,))</span>
<span id="cb49-13"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-13" tabindex="-1"></a>    x <span class="op">=</span> Dense(num_units, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>)(i)</span>
<span id="cb49-14"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-14" tabindex="-1"></a>    x <span class="op">=</span> Dense(num_units, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>)(x)</span>
<span id="cb49-15"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-15" tabindex="-1"></a></span>
<span id="cb49-16"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-16" tabindex="-1"></a>    <span class="cf">return</span> i, x</span>
<span id="cb49-17"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-17" tabindex="-1"></a></span>
<span id="cb49-18"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-18" tabindex="-1"></a></span>
<span id="cb49-19"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-19" tabindex="-1"></a><span class="kw">def</span> rnn(T, D, num_units<span class="op">=</span><span class="dv">32</span>, rnn_model<span class="op">=</span><span class="st">&quot;lstm&quot;</span>):</span>
<span id="cb49-20"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-20" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb49-21"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-21" tabindex="-1"></a><span class="co">    Create a Recurrent Neural Network (RNN) model.</span></span>
<span id="cb49-22"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-22" tabindex="-1"></a></span>
<span id="cb49-23"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-23" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb49-24"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-24" tabindex="-1"></a><span class="co">        T (int): Time steps or input size.</span></span>
<span id="cb49-25"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-25" tabindex="-1"></a><span class="co">        D (int): Dimensionality of the input.</span></span>
<span id="cb49-26"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-26" tabindex="-1"></a><span class="co">        num_layers (int): Number of layers in the RNN.</span></span>
<span id="cb49-27"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-27" tabindex="-1"></a><span class="co">        rnn_model (str): RNN model type (&#39;lstm&#39;, &#39;gru&#39;, or &#39;simple_rnn&#39;).</span></span>
<span id="cb49-28"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-28" tabindex="-1"></a></span>
<span id="cb49-29"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-29" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb49-30"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-30" tabindex="-1"></a><span class="co">        tuple: Input and output tensors of the RNN model.</span></span>
<span id="cb49-31"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-31" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb49-32"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-32" tabindex="-1"></a>    i <span class="op">=</span> Input(shape<span class="op">=</span>(T, D))</span>
<span id="cb49-33"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-33" tabindex="-1"></a>    <span class="cf">if</span> rnn_model <span class="op">==</span> <span class="st">&#39;lstm&#39;</span>:</span>
<span id="cb49-34"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-34" tabindex="-1"></a>        x <span class="op">=</span> LSTM(num_units, return_sequences<span class="op">=</span><span class="va">True</span>)(i)</span>
<span id="cb49-35"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-35" tabindex="-1"></a>        x <span class="op">=</span> LSTM(num_units)(x)</span>
<span id="cb49-36"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-36" tabindex="-1"></a>    <span class="cf">elif</span> rnn_model <span class="op">==</span> <span class="st">&#39;gru&#39;</span>:</span>
<span id="cb49-37"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-37" tabindex="-1"></a>        x <span class="op">=</span> GRU(num_units, return_sequences<span class="op">=</span><span class="va">True</span>)(i)</span>
<span id="cb49-38"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-38" tabindex="-1"></a>        x <span class="op">=</span> GRU(num_units)(x)</span>
<span id="cb49-39"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-39" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb49-40"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-40" tabindex="-1"></a>        x <span class="op">=</span> SimpleRNN(num_units, return_sequences<span class="op">=</span><span class="va">True</span>)(i)</span>
<span id="cb49-41"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-41" tabindex="-1"></a>        x <span class="op">=</span> SimpleRNN(num_units)(x)</span>
<span id="cb49-42"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-42" tabindex="-1"></a></span>
<span id="cb49-43"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-43" tabindex="-1"></a>    <span class="cf">return</span> i, x</span>
<span id="cb49-44"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-44" tabindex="-1"></a></span>
<span id="cb49-45"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-45" tabindex="-1"></a></span>
<span id="cb49-46"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-46" tabindex="-1"></a><span class="kw">def</span> cnn(T, D):</span>
<span id="cb49-47"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-47" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb49-48"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-48" tabindex="-1"></a><span class="co">    Create a Convolutional Neural Network (CNN) model.</span></span>
<span id="cb49-49"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-49" tabindex="-1"></a></span>
<span id="cb49-50"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-50" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb49-51"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-51" tabindex="-1"></a><span class="co">        T (int): Time steps or input size.</span></span>
<span id="cb49-52"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-52" tabindex="-1"></a><span class="co">        D (int): Dimensionality of the input.</span></span>
<span id="cb49-53"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-53" tabindex="-1"></a></span>
<span id="cb49-54"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-54" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb49-55"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-55" tabindex="-1"></a><span class="co">        tuple: Input and output tensors of the CNN model.</span></span>
<span id="cb49-56"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-56" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb49-57"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-57" tabindex="-1"></a>    i <span class="op">=</span> Input(shape<span class="op">=</span>(T, D))</span>
<span id="cb49-58"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-58" tabindex="-1"></a>    x <span class="op">=</span> Conv1D(<span class="dv">16</span>, <span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>, padding<span class="op">=</span><span class="st">&#39;same&#39;</span>)(i)</span>
<span id="cb49-59"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-59" tabindex="-1"></a>    x <span class="op">=</span> MaxPooling1D(<span class="dv">2</span>)(x)</span>
<span id="cb49-60"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-60" tabindex="-1"></a>    x <span class="op">=</span> Conv1D(<span class="dv">32</span>, <span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>, padding<span class="op">=</span><span class="st">&#39;same&#39;</span>)(x)</span>
<span id="cb49-61"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-61" tabindex="-1"></a>    x <span class="op">=</span> GlobalMaxPooling1D()(x)</span>
<span id="cb49-62"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-62" tabindex="-1"></a></span>
<span id="cb49-63"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb49-63" tabindex="-1"></a>    <span class="cf">return</span> i, x</span></code></pre></div>
</details>
<p>In the <code>StocksForecastDL</code> class, we have the following methods after the class is initialized: <code>prepare_data()</code>, <code>make_predictions()</code>, <code>run_forecast()</code>, and, finally, <code>single_model_comparison()</code>. These methods are self-explanatory by their names. It is worth noting that the <code>run_forecast()</code> method accepts an input named <code>multistep</code> which is a Boolean value. Suppose our forecast horizon is 15 days. When <code>multioutput=False</code>, we use a single-step model to forecast the next 15 days. That is, the model predicts the first day, then use that prediction in the prediction of the second day, and so on. If we set <code>multioutput=True</code>, the model will predict all 15 days at once, given information available on the day before. The <code>single_model_comparison()</code> method can be called to compare these two (single- versus multi-output) forecasts for a deep learning model such as ANN or LSTM.</p>
<p>The number of epochs is an important hyperparameter when it comes to deep learning models. Practitioners often plot the losses from training and validation/test data sets to examine if the algorithm has “converged” or if over-fitting has happened. Below are such plots from ANN and LSTM for the single-step forecast models with 1500 epochs. Both show some evidence of over-fitting, especially ANN, as the test/validation loss continues to increase while the train loss stays flat after about 600 epochs:</p>
<div class="float">
<img src="images/ann_single_hist.png" alt="Plot of Losses from ANN" />
<div class="figcaption">Plot of Losses from ANN</div>
</div>
<div class="float">
<img src="images/rnn_lstm_single_hist.png" alt="Plot of Losses from LSTM" />
<div class="figcaption">Plot of Losses from LSTM</div>
</div>
<p>Comparatively, for the multi-output model using LSTM, 1500 epochs seems to be ideal, as train loss continues to lower and the test/validation loss stays flat:</p>
<div class="float">
<img src="images/rnn_lstm_multi_hist.png" alt="Plot of Losses from LSTM for the Multi-output Model" />
<div class="figcaption">Plot of Losses from LSTM for the Multi-output Model</div>
</div>
<p>Another important parameter in our script is value of <code>t</code>, which is given a default value of 10 when the <code>StockForecastDL</code> class is initiated. This is the size of the training data set for these deep learning models. Or equivalently, you can think that the number of features is 10. Suppose the algorithm is attempting to predict the stock price for February 20, 2023, which is a Monday, it uses stock prices from February 6 (Monday) to February 17 (Friday) as its inputs. Increasing the number <code>t</code> has two opposite effect on model training and prediction. On the one hand, it makes the data set wider, which allows the model to be trained with more features. On the other hand, it makes the data set shorter, as more days in the beginning of the data set need to be reserved for training. Imagine you have the time series for 360 days. If <code>t=10</code>, then your data set has 11 columns (10 features and 1 outcome) and 350 rows. But if <code>t=180</code>, then your data set has 181 columns (180 features and 1 output) but only 180 rows. In general, time series models favor longer rather than wider data. In our example, I have increased the value of <code>t</code> to 20 and the results are quite similar.</p>
<p>For the deep learning models, we conduct two types of comparisons. First, as already mentioned, we compare multi-step forecasts from the single-step and the multi-output models. Here is the comparison for CNN:</p>
<div class="float">
<img src="images/cnn_comparison.png" alt="Single-step vs. Multi-output Comparison for CNN" />
<div class="figcaption">Single-step vs. Multi-output Comparison for CNN</div>
</div>
<p>In the graph, “Log” is original data series, “1step_test” is one-step forecast from the single-step model, i.e., each prediction uses the true historical data, “multistep” is multi-period forecast from the single-step model as described earlier, and “multioutput” is from the multi-output CNN model by setting <code>multioutput=True</code>, i.e., all 20 days are predicted at the same time. The one-step forecast is expected to do well, as it forecasts with true information. However, we can also visually see that, at least for CNN, the multi-period (“multistep” on the graph) forecast from the single-step model outperforms the multi-output model.</p>
<p>For a more formal comparison, we run these models with 10 stocks and for 6 different forecast horizons: 5, 10, 20, 50, 100, and 200 days. We calculate the report the averages <strong>mean absolute percentage error</strong> (MAPE) from the 10 stocks. Below is the result. Note that <code>Prophet</code>, which we will formally introduce in the next section, is also included:</p>
<p><img src="images/comparison_dl.png" /></p>
<p>A smaller value of MAPE indicates better model fit. Not surprisingly, the single-period models outperform the multi-step models when the time horizon is short, but for 50 days and above, the multi-step models are significantly better.</p>
</div>
<div id="facebooks-prophet" class="section level2 hasAnchor" number="3.7">
<h2><span class="header-section-number">3.7</span> Facebook’s Prophet<a href="time-series-forecasting-and-deep-learning-algorithms.html#facebooks-prophet" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Facebook’s <a href="https://facebook.github.io/prophet/">Prophet</a> is a Bayesian model rather than a deep learning model. But it is purposedly built for forecasting. The Prophet is built on top of standard regression techniques and utilizes a decomposable time series model with multiple seasonalities using a Fourier series. It also accepts user-defined holidays making it highly customizable for applications in different regions.</p>
<p>A new model, named <a href="https://neuralprophet.com/">NeuralProphet</a>, has combined Prophet and deep learning. Since it is based on <code>PyTorch</code> instead of <code>TensorFlow</code>/<code>Keras</code>, we will not look at it in this chapter.</p>
<p>Here is the script that we use to implement Prophet on the stock prices. It should be noted that the true power of <code>Prophet</code> is in other common business applications rather than stock prices. We continue to use stock prices here just for illustrative purposes:</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb50-2"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-2" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb50-3"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb50-4"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-4" tabindex="-1"></a><span class="im">from</span> prophet <span class="im">import</span> Prophet</span>
<span id="cb50-5"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-5" tabindex="-1"></a><span class="im">from</span> prophet.diagnostics <span class="im">import</span> cross_validation, performance_metrics</span>
<span id="cb50-6"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-6" tabindex="-1"></a><span class="im">from</span> prophet.plot <span class="im">import</span> plot_cross_validation_metric</span>
<span id="cb50-7"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-7" tabindex="-1"></a><span class="im">from</span> prophet.plot <span class="im">import</span> add_changepoints_to_plot</span>
<span id="cb50-8"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-8" tabindex="-1"></a></span>
<span id="cb50-9"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-9" tabindex="-1"></a></span>
<span id="cb50-10"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-10" tabindex="-1"></a><span class="kw">class</span> StocksForecastProphet:</span>
<span id="cb50-11"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-11" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb50-12"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-12" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb50-13"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-13" tabindex="-1"></a>        stock_name_list<span class="op">=</span>(<span class="st">&#39;UAL&#39;</span>, <span class="st">&#39;WMT&#39;</span>, <span class="st">&#39;PFE&#39;</span>),</span>
<span id="cb50-14"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-14" tabindex="-1"></a>        start_date<span class="op">=</span><span class="st">&#39;2018-01-01&#39;</span>,</span>
<span id="cb50-15"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-15" tabindex="-1"></a>        end_date<span class="op">=</span><span class="st">&#39;2022-12-31&#39;</span>,</span>
<span id="cb50-16"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-16" tabindex="-1"></a>        n_test<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb50-17"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-17" tabindex="-1"></a>    ):</span>
<span id="cb50-18"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-18" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb50-19"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-19" tabindex="-1"></a><span class="co">        Initialize the StocksForecastProphet class.</span></span>
<span id="cb50-20"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-20" tabindex="-1"></a></span>
<span id="cb50-21"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-21" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb50-22"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-22" tabindex="-1"></a><span class="co">            stock_name_list (tuple): List of stock names.</span></span>
<span id="cb50-23"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-23" tabindex="-1"></a><span class="co">            start_date (str): Start date for data retrieval.</span></span>
<span id="cb50-24"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-24" tabindex="-1"></a><span class="co">            end_date (str): End date for data retrieval.</span></span>
<span id="cb50-25"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-25" tabindex="-1"></a><span class="co">            n_test (int): Length of forecast horizon.</span></span>
<span id="cb50-26"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-26" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb50-27"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-27" tabindex="-1"></a>        <span class="va">self</span>.N_TEST <span class="op">=</span> n_test</span>
<span id="cb50-28"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-28" tabindex="-1"></a>        <span class="va">self</span>.dfs <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb50-29"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-29" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> stock_name_list:</span>
<span id="cb50-30"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-30" tabindex="-1"></a>            <span class="va">self</span>.dfs[name] <span class="op">=</span> yf.download(name, start<span class="op">=</span>start_date, end<span class="op">=</span>end_date)</span>
<span id="cb50-31"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-31" tabindex="-1"></a>            <span class="va">self</span>.dfs[name][<span class="st">&#39;Diff&#39;</span>] <span class="op">=</span> <span class="va">self</span>.dfs[name][<span class="st">&#39;Close&#39;</span>].diff(<span class="dv">1</span>)</span>
<span id="cb50-32"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-32" tabindex="-1"></a>            <span class="va">self</span>.dfs[name][<span class="st">&#39;Log&#39;</span>] <span class="op">=</span> np.log(<span class="va">self</span>.dfs[name][<span class="st">&#39;Close&#39;</span>])</span>
<span id="cb50-33"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-33" tabindex="-1"></a>            <span class="va">self</span>.dfs[name][<span class="st">&#39;DiffLog&#39;</span>] <span class="op">=</span> <span class="va">self</span>.dfs[name][<span class="st">&#39;Log&#39;</span>].diff(<span class="dv">1</span>)</span>
<span id="cb50-34"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-34" tabindex="-1"></a>            <span class="va">self</span>.dfs[name][<span class="st">&#39;ds&#39;</span>] <span class="op">=</span> <span class="va">self</span>.dfs[name].index</span>
<span id="cb50-35"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-35" tabindex="-1"></a></span>
<span id="cb50-36"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-36" tabindex="-1"></a>    <span class="kw">def</span> run_prophet(</span>
<span id="cb50-37"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-37" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb50-38"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-38" tabindex="-1"></a>        stock_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">&#39;UAL&#39;</span>,</span>
<span id="cb50-39"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-39" tabindex="-1"></a>        col: <span class="bu">str</span> <span class="op">=</span> <span class="st">&#39;Log&#39;</span>,</span>
<span id="cb50-40"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-40" tabindex="-1"></a>        cv: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb50-41"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-41" tabindex="-1"></a>        plot: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb50-42"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-42" tabindex="-1"></a>    ):</span>
<span id="cb50-43"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-43" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb50-44"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-44" tabindex="-1"></a><span class="co">        Run the Prophet forecasting model for a given stock.</span></span>
<span id="cb50-45"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-45" tabindex="-1"></a></span>
<span id="cb50-46"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-46" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb50-47"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-47" tabindex="-1"></a><span class="co">            stock_name (str): Name of the stock.</span></span>
<span id="cb50-48"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-48" tabindex="-1"></a><span class="co">            col (str): Column to be used for forecasting.</span></span>
<span id="cb50-49"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-49" tabindex="-1"></a><span class="co">            cv (bool): Whether to conduct cross validation. Default is False.</span></span>
<span id="cb50-50"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-50" tabindex="-1"></a><span class="co">            plot (bool): Whether to plot. Default is True.</span></span>
<span id="cb50-51"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-51" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb50-52"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-52" tabindex="-1"></a>        df0 <span class="op">=</span> <span class="va">self</span>.dfs[stock_name]</span>
<span id="cb50-53"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-53" tabindex="-1"></a>        df0[<span class="st">&#39;y&#39;</span>] <span class="op">=</span> df0[col]</span>
<span id="cb50-54"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-54" tabindex="-1"></a>        df <span class="op">=</span> df0[:<span class="op">-</span><span class="va">self</span>.N_TEST].copy()</span>
<span id="cb50-55"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-55" tabindex="-1"></a></span>
<span id="cb50-56"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-56" tabindex="-1"></a>        m <span class="op">=</span> Prophet(yearly_seasonality<span class="op">=</span><span class="va">True</span>, weekly_seasonality<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-57"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-57" tabindex="-1"></a>        m.fit(df)</span>
<span id="cb50-58"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-58" tabindex="-1"></a></span>
<span id="cb50-59"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-59" tabindex="-1"></a>        future <span class="op">=</span> <span class="va">self</span>.dfs[stock_name][<span class="st">&#39;ds&#39;</span>].reset_index()</span>
<span id="cb50-60"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-60" tabindex="-1"></a>        forecast <span class="op">=</span> m.predict(future)</span>
<span id="cb50-61"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-61" tabindex="-1"></a>        <span class="va">self</span>.dfs[stock_name][<span class="st">&#39;yhat&#39;</span>] <span class="op">=</span> forecast[<span class="st">&#39;yhat&#39;</span>].values</span>
<span id="cb50-62"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-62" tabindex="-1"></a></span>
<span id="cb50-63"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-63" tabindex="-1"></a>        <span class="cf">if</span> cv:</span>
<span id="cb50-64"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-64" tabindex="-1"></a>            df_cv <span class="op">=</span> cross_validation(</span>
<span id="cb50-65"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-65" tabindex="-1"></a>                m,</span>
<span id="cb50-66"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-66" tabindex="-1"></a>                initial<span class="op">=</span><span class="st">&#39;730 days&#39;</span>,</span>
<span id="cb50-67"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-67" tabindex="-1"></a>                period<span class="op">=</span><span class="st">&#39;30 days&#39;</span>,</span>
<span id="cb50-68"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-68" tabindex="-1"></a>                horizon<span class="op">=</span><span class="st">&#39;30 days&#39;</span>,</span>
<span id="cb50-69"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-69" tabindex="-1"></a>                disable_tqdm<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb50-70"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-70" tabindex="-1"></a>            )</span>
<span id="cb50-71"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-71" tabindex="-1"></a></span>
<span id="cb50-72"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-72" tabindex="-1"></a>            pm <span class="op">=</span> performance_metrics(df_cv)</span>
<span id="cb50-73"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-73" tabindex="-1"></a>            <span class="bu">print</span>(pm)</span>
<span id="cb50-74"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-74" tabindex="-1"></a></span>
<span id="cb50-75"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-75" tabindex="-1"></a>            plot_cross_validation_metric(df_cv, metric<span class="op">=</span><span class="st">&#39;mape&#39;</span>)</span>
<span id="cb50-76"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-76" tabindex="-1"></a>            plt.savefig(<span class="st">&quot;prophet_cv_mape.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb50-77"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-77" tabindex="-1"></a></span>
<span id="cb50-78"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-78" tabindex="-1"></a>        <span class="cf">if</span> plot:</span>
<span id="cb50-79"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-79" tabindex="-1"></a>            fig <span class="op">=</span> m.plot(forecast, figsize<span class="op">=</span>(<span class="dv">28</span>, <span class="dv">8</span>))</span>
<span id="cb50-80"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-80" tabindex="-1"></a>            add_changepoints_to_plot(fig.gca(), m, forecast)</span>
<span id="cb50-81"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-81" tabindex="-1"></a>            plt.savefig(<span class="st">&quot;prophet_with_changepoints.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb50-82"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-82" tabindex="-1"></a></span>
<span id="cb50-83"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-83" tabindex="-1"></a>            m.plot_components(forecast)</span>
<span id="cb50-84"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-84" tabindex="-1"></a>            plt.savefig(<span class="st">&quot;prophet_components&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb50-85"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-85" tabindex="-1"></a></span>
<span id="cb50-86"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-86" tabindex="-1"></a></span>
<span id="cb50-87"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-87" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb50-88"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-88" tabindex="-1"></a>    ts <span class="op">=</span> StocksForecastProphet()</span>
<span id="cb50-89"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-89" tabindex="-1"></a>    ts.run_prophet(cv<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-90"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-90" tabindex="-1"></a></span>
<span id="cb50-91"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-91" tabindex="-1"></a><span class="co"># Making Prophet to work with Python 3.9 in MacBook Pro:</span></span>
<span id="cb50-92"><a href="time-series-forecasting-and-deep-learning-algorithms.html#cb50-92" tabindex="-1"></a><span class="co"># https://www.google.com/search?client=firefox-b-1-d&amp;q=mac+how+to+open+usr%2Flocal+in+finder</span></span></code></pre></div>
</details>
<p>In the above script, the stock we used is United Airlines (UAL). Three figures were produced. The first figure shows the several seasonality components considered by the model, which include the overall trend and weekly and yearly seasonality. At least two of th peaks in annual seasonality can be easily explained: one in summer around late June, and another in winter around Thanksgiving.</p>
<p><img src="images/prophet_components.png" /></p>
<p>The second figure shows several change points based on Prophet’s algorithm:</p>
<p><img src="images/prophet_with_changepoints.png" /></p>
<p>The change points made sense as the market for airlines and other travel related stocks has been versatile since spring of 2020 due to COVID-19.</p>
<p>Lastly, we have the figure that shows the value of MAPE for different cross-validation forecast horizons:</p>
<p><img src="images/prophet_cv_mape.png" /></p>
</div>
<div id="summary-1" class="section level2 hasAnchor" number="3.8">
<h2><span class="header-section-number">3.8</span> Summary<a href="time-series-forecasting-and-deep-learning-algorithms.html#summary-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this chapter, we discuss the topic of forecasting as a <em>regression</em> problem. The word “regression” was emphasized for two reasons. First, the deep learning algorithms discussed in this chapter can be applied to other regression problems. Second, forecasting problems can be classification problems, either by transformation or my the nature of the problem. For example, instead of forecasting stock prices, we can forecast whether prices are going up or trending down. This transformed a regression problem into a classification problem. On the other hand, forecasting whether a customer will continue to pay off mortgage in full is naturally a classification as the outcome can be only “yes” or “no”.</p>
<p>While this chapter uses the deep learning models for regression, it should be reminded that they are as powerful in classification problems. The only change that needed to be made, from a coding perspective, is that a activation function that returns a probability needed to be specified in the last <code>Dense</code> layer. Popular activation functions are <code>tanh</code> and <code>ReLU</code>.</p>
<p>The biggest appeal of using neural networks for forecasting tasks is the their ability to perform what we called the <strong>multi-output</strong> forecasts, i.e., train the model to output predictions for multiple periods at once. In our comparison, we saw that when the forecast horizon is long, these multi-output models performed well.</p>
<p>One important aspect of using neural networks for forecasting tasks is the construction of the training data set. We have emphasized the importance of the parameter <code>t</code> when we discussed the scripts. This parameter directly affects the width of the training data set, i.e., the number of features, but also indirectly affects the length of the training data set as a bigger <code>t</code> value requires more data to be reserved for training in the beginning of the time series.</p>
<p>Traditionally, machine learning algorithms are broadly divided into three categories: supervised learning, unsupervised learning, and reinforcement learning. When we were constructing the training data set in this chapter, we were actually getting started with the fourth type of machine learning: <strong>self-supervised learning</strong>. As its name suggests, self-supervised learning is a kind of supervised learning, but the target and training data set were constructed and optimized by the algorithm itself. In the context of forecasting, a true self-supervised learning algorithm could be one to pick the value <code>t</code>, the number of periods to look back, in order to make the best forecasts given other hyperparameters. This simple task may be done by grid search. A more complicated, and likely more real example for self-supervised learning in forecasting is for the algorithm to find the best “look-back” strategy. For example, may be it is best to only look at prices of the past three Fridays’.</p>
<p>Using deep learning models in forecasting is a bit of a overkill, although some of these models, such as LSTM, naturally sounded like they would do a good job in time-series tasks. Deep learning models can really shine in computer vision, voice recognition, and natural language processing (NLP) tasks. Later chapters will have brief coverage of these topics.</p>
</div>
<div id="references-incomplete" class="section level2 hasAnchor" number="3.9">
<h2><span class="header-section-number">3.9</span> References (incomplete)<a href="time-series-forecasting-and-deep-learning-algorithms.html#references-incomplete" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li><a href="https://www.udemy.com/course/time-series-analysis/" class="uri">https://www.udemy.com/course/time-series-analysis/</a></li>
</ul>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="discrete-choice-classification-and-tree-based-ensemble-algorithms.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="regression-reconsidered.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/datahurdler/Econ-ML-Book/edit/master/03-forecasting-en.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
